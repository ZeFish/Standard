@use "standard-00-variables" as *;

/**
 * @component Vertical Rhythm System
 * @category Layout
 * @description Enhanced bulletproof rhythm system that prevents margin collapse
 * and ensures consistent vertical spacing throughout the document. Based on the
 * 1rlh (relative line height) rhythm unit for mathematical precision.
 * Applied globally to <html> root for cascade throughout the page.
 * Supports responsive rhythm adjustments and granular control per element.
 *
 * @prop {class} .rhythm Apply rhythm spacing to <html> root or any container
 * @prop {class} .no-rhythm Disable rhythm for specific elements
 * @prop {variable} --base Base rhythm unit (1rlh)
 * @prop {variable} --rhythm-gap Normal element spacing multiplier (default: 1)
 * @prop {variable} --rhythm-gap-block Block element spacing multiplier
 * @prop {variable} --body-padding Padding multiplier for <body> (desktop)
 * @prop {variable} --body-mobile-padding-multiplier Padding multiplier for <body> (mobile)
 *
 * @example
 * // Global: <html> has .rhythm class (applied automatically)
 * <html class="rhythm">
 *   <body>
 *     <!-- All content gets rhythm spacing -->
 *     <h1>Title</h1>
 *     <p>Paragraphs get automatic spacing</p>
 *   </body>
 * </html>
 *
 * // Local: Apply .rhythm to specific container
 * <div class="rhythm">
 *   <h1>Section Title</h1>
 *   <p>Container children get rhythm spacing</p>
 * </div>
 *
 * // Disable: Use .no-rhythm to opt-out
 * <section class="no-rhythm">No spacing applied here</section>
 * <div class="rhythm no-rhythm">Explicitly disabled rhythm</div>
 *
 * @since 0.1.0
 * @see standard-01-token.scss
 * @see standard-06-reading.scss
 */

/* Enhanced Bulletproof Rhythm System - Margin Collapse Safe */

/* ===== Harmony Base (containers and resets) ===== */
:where(*, *::before, *::after) {
    box-sizing: border-box;
}

/* ===== BULLETPROOF RHYTHM SYSTEM ===== */
/* Applied to <html> root for global cascade (best practice for frameworks) */
:where(html:not(.no-rhythm)),
:where(.rhythm) {
    /* Rhythm control - can be overridden per instance */

    /* Modern margin collapse prevention */
    display: flow-root;

    /* Apply rhythm spacing to all direct children */
    > * {
        margin-block-start: 0;
        margin-block-end: calc(var(--base) * var(--rhythm-gap));
    }
}

/* Padding only applied to <body> when rhythm is active */
:where(body:not(.no-rhythm)),
:where(html:not(.no-rhythm)) > body {
    margin: 0;
    padding: var(--body-padding);
    padding-bottom: calc((var(--base) * var(--body-padding) * 1.5));
    [id] {
        scroll-margin-top: calc(
            var(--base) * var(--body-padding)
        ); /* Adjust value as needed */
    }
}

@media (max-width: #{$small}) {
    :where(body:not(.no-rhythm)),
    :where(html:not(.no-rhythm)) > body {
        margin: 0;
    }
}

/* Elements within rhythm containers */
/* Enhanced spacing relationships for typography */
:where(html:not(.no-rhythm), .rhythm) {
    @include apply-rhythm {
        margin-block-start: 0;
        margin-block-end: calc(var(--base) * var(--rhythm-gap));
    }

    .rhythm {
        --rhythm-gap: 1; /* Reset for nested contexts */
    }

    /* Special blocks get generous spacing (2× rhythm) */
    /* Layout containers get double spacing for emphasis */
    @include apply-rhythm-block {
        margin-block-start: calc(
            (var(--base) * max(var(--rhythm-gap-block), var(--rhythm-gap))) -
                (var(--base) * var(--rhythm-gap))
        );
        margin-block-end: calc(
            var(--base) * max(var(--rhythm-gap-block), var(--rhythm-gap))
        );
    }

    * > :where(:last-child) {
        margin-block-end: 0;
    }

    /* =========================== */
    /* TYPOGRAPHIC NUANCES         */
    /* =========================== */

    /* Exception for grid in a prose div */
    .prose > [class^="grid-"],
    .prose > .grid {
        margin-block-start: calc(
            (var(--base) * max(var(--rhythm-gap-block), var(--rhythm-gap))) -
                (var(--base) * var(--rhythm-gap))
        );
        margin-block-end: calc(
            var(--base) * max(var(--rhythm-gap-block), var(--rhythm-gap))
        );
    }

    hr {
        --rhythm-gap-block: calc(var(--rhythm-gap) * 3);
    }

    /* Reset first-child spacing for special blocks */
    blockquote > :first-child,
    pre > :first-child,
    figure > :first-child,
    .callout .callout-content > :first-child {
        margin-block-start: 0;
    }
    blockquote > :last-child,
    pre > :last-child,
    figure > :last-child,
    .callout .callout-content > :last-child {
        margin-block-end: 0;
    }

    /* =========================== */
    /* TYPOGRAPHY ELEMENTS         */
    /* =========================== */

    /* Typography-specific spacing adjustments */

    /* =========================== */
    /* CONTENT ELEMENTS            */
    /* =========================== */

    /* Lists */
    ul,
    ol {
        list-style: none;
        padding-inline-start: var(--base);
    }

    p:has(+ ul),
    p:has(+ ol) {
        margin-block-end: var(--base-small);
    }

    ol ul,
    ol ol,
    ul ul,
    ul ol {
        margin-block-start: var(--base);
    }

    /* Nested lists */
    li > ul,
    li > ol {
        padding-inline-start: var(--base);
        margin-block-end: 0;
    }

    /* List items */
    li {
        position: relative;
        margin: 0;
        padding-inline-start: 0;
        margin-block-end: var(--base-small);
    }

    /* Unordered list bullets */
    ul > li::before {
        content: "•";
        position: absolute;
        left: calc(var(--base) * -1);
        width: var(--base);
        text-align: center;
        color: var(--color-subtle);
    }

    /* Ordered list numbers */
    ol {
        counter-reset: ol-counter;
    }

    ol > li {
        counter-increment: ol-counter;
    }

    ol > li::before {
        content: counter(ol-counter) ".";
        position: absolute;
        left: calc(var(--base) * -1.75);
        text-align: right;
        line-height: inherit;
        color: var(--color-subtle);
        font-variant-numeric: tabular-nums;
        overflow: hidden;
        width: calc(var(--base) * 1.5);
    }

    ul.no-bullet,
    ol.no-bullet {
        list-style: none;
        padding-inline-start: 0;
    }
    ul.no-bullet li::before,
    ol.no-bullet li::before {
        display: none;
    }

    /* Inline lists - remove margin-bottom from list items */
    ul:where(.display-flex, [style*="display: flex"], [style*="display:flex"])
        li,
    ol:where(.display-flex, [style*="display: flex"], [style*="display:flex"])
        li {
        margin-block-end: 0;
    }

    ul.tight li,
    ol.tight li,
    li:last-of-type {
        /*line-height: var(--line-height);*/
        margin-block-end: 0;
    }

    /* =========================== */
    /* FORMS AND INTERACTIVE       */
    /* =========================== */

    /* Form containers - avoid nested grids */
    form:not(.grid *) {
        display: grid;
        gap: calc(var(--base-d2) * var(--rhythm-gap));
    }

    /* Forms inside grids use flex layout to avoid nesting issues */
    .grid form {
        display: flex;
        flex-direction: column;
        gap: calc(var(--base-d2) * var(--rhythm-gap));
    }

    /* Form field groups - spacing only */
    fieldset {
        padding: calc(var(--base-d2) * var(--rhythm-gap));
        display: grid;
        gap: calc(var(--base-d5) * var(--rhythm-gap));
    }

    legend {
        padding-inline: calc(var(--base-d3) * var(--rhythm-gap));
    }

    /* Form inputs */
    input,
    textarea,
    select {
        margin: 0;
    }

    /* Labels - spacing only */
    label {
        margin: 0;
    }

    /* Label + input pairs */
    label:has(+ input[type="text"]),
    label:has(+ input[type="email"]),
    label:has(+ input[type="password"]),
    label:has(+ textarea),
    label:has(+ select) {
        margin-block-start: calc(var(--base-d3) * var(--rhythm-gap));
        margin-inline-start: calc(var(--base-d2) * var(--rhythm-gap));
    }
    fieldset div,
    fieldset p {
        margin-inline-start: calc(var(--base-d2) * var(--rhythm-gap));
    }

    /* Checkbox/radio with labels */
    label + input[type="checkbox"],
    label + input[type="radio"] {
        margin-inline-start: calc(var(--base-d2) * var(--rhythm-gap));
    }

    /* Button groups */
    .button-group {
        display: flex;
        gap: calc(var(--base-d2) * var(--rhythm-gap));
        flex-wrap: wrap;
    }

    /* =========================== */
    /* MEDIA ELEMENTS              */
    /* =========================== */

    /* Images, videos, etc. */
    img,
    video,
    audio,
    iframe {
        max-width: 100%;
        height: auto;
    }

    /* Figures */
    figure {
        display: grid;
        gap: calc(var(--base-d3) * var(--rhythm-gap));
    }

    figcaption {
        /* Spacing handled by rhythm system */
    }

    /* =========================== */
    /* TABLES                      */
    /* =========================== */

    caption {
        margin-block-end: calc(var(--base-d3) * var(--rhythm-gap));
    }

    /* Swiss-style data tables */
    table {
        /* You already have: border-collapse: collapse; */
        width: 100%;
        /* font-variant-numeric: tabular-nums;*/ /* ADD: Monospace numbers */
    }

    td,
    th {
        border-bottom: var(--border);
        font-size: var(--scale-d2);
        padding-block: calc(var(--base-d3) * var(--rhythm-gap));
        padding-inline: calc(var(--base-d2) * var(--rhythm-gap));
    }

    th {
        /* You already have: text-align: left; font-weight: bold; */
        text-transform: uppercase; /* ADD */
        letter-spacing: 0.05em; /* ADD */
    }

    /* ADD: Numeric column alignment */
    .numeric {
        text-align: right;
        font-variant-numeric: tabular-nums;
    }

    /* ADD: Zebra striping (functional, not decorative) */
    .striped tbody tr:nth-child(even) {
        background: color-mix(in srgb, var(--color-foreground) 3%, transparent);
    }

    /* ADD: tight table variant */
    .tight th,
    .tight td {
        padding-block: calc(var(--base-d4) * var(--rhythm-gap));
        padding-inline-end: calc(var(--base-d3) * var(--rhythm-gap));
    }
}

/* =========================== */
/* UTILITY CLASSES            */
/* =========================== */

/* Spacing override utilities */
.rhythm-tight {
    --rhythm-gap: 0.5;
}

.rhythm-relaxed {
    --rhythm-gap: 1.5;
}

.rhythm-xl {
    --rhythm-gap: 2;
}

/* Individual element overrides */
.no-rhythm {
    margin: 0 !important;
}

.no-block-start {
    margin-block-start: 0 !important;
}

.no-block-end {
    margin-block-end: 0 !important;
}

.stick-next {
    margin-block-end: calc(var(--base-d3) * var(--rhythm-gap)) !important;
}

/* =========================== */
/* PERFORMANCE OPTIMIZATIONS  */
/* =========================== */

/* Reduce repaints and reflows */
.rhythm {
    /* Use GPU acceleration for transforms if needed */
    /*transform: translateZ(0); */

    /* Optimize for animations */
    /*will-change: auto; */
}

/* =========================== */
/* ACCESSIBILITY               */
/* =========================== */

/* Ensure rhythm doesn't interfere with screen readers */
.rhythm:focus-within {
    /* Maintain focus visibility */
}

/* Respect user motion preferences */
@media (prefers-reduced-motion: reduce) {
    .rhythm {
        transition: none;
    }
}

/* =========================== */
/* LEGACY SUPPORT             */
/* =========================== */

/* Fallback for browsers without CSS Grid support */
@supports not (display: grid) {
    .rhythm {
        display: block;

        > * {
            margin-block-end: calc(var(--base) * var(--rhythm-gap));
        }

        > :last-child {
            margin-block-end: 0;
        }
    }
}

/* Enhanced Bulletproof Rhythm System - Margin Collapse Safe */
/* Rhythm tokens are now consolidated in standard-00-token.scss */

/* ===== Harmony Base (containers and resets) ===== */
:where(*, *::before, *::after) {
    box-sizing: border-box;
}

/* Containers usable across pages */
.container {
    padding-inline: var(--container-standard);
}
.container-full {
    margin-inline: auto;
    padding-inline: var(--container-standard);
}

/* Universal reset for rhythm-managed elements
:where(
    h1,
    h2,
    h3,
    h4,
    h5,
    h6,
    p,
    ul,
    ol,
    dl,
    blockquote,
    pre,
    table,
    figure,
    form,
    fieldset,
    div,
    section,
    article,
    aside,
    header,
    footer,
    nav,
    input,
    textarea,
    select,
    button,
    label,
    legend
) {
    margin: 0;
}
*/
/* Logical unsets for first/last child when containers apply margins */
:where(:first-child) {
    margin-block-start: unset;
}
:where(:last-child) {
    margin-block-end: unset;
}

/* ===== BULLETPROOF RHYTHM SYSTEM ===== */

.rhythm {
    /* Prevent nested rhythm from double-spacing - token defined in tokens file */

    /* Debug mode visualization - moved to debug section */

    /* =========================== */
    /* MARGIN-COLLAPSE-SAFE CORE   */
    /* =========================== */

    /* Default: Use margins with collapse prevention (allows typographic nuances) */
    /*display: block;*/

    /* Create new block formatting context to prevent margin collapse */
    contain: layout style;

    /* Alternative: Use padding on container to prevent collapse */
    padding-block-start: 1px;
    padding-block-end: 1px;
    margin-block-start: -1px;
    margin-block-end: -1px;

    > * {
        margin-block: 0;
        margin-block-end: calc(var(--space-block) * var(--rhythm-multiplier));
    }

    > :last-child {
        margin-block-end: 0;
    }

    > :first-child {
        margin-block-start: 0;
    }
}

/* =========================== */
/* NESTING PROTECTION          */
/* =========================== */

/* Nested rhythm containers don't double-space */
/* Apply to both explicit rhythm classes and semantic elements */
/*
.rhythm .rhythm,
.rhythm section,
.rhythm article,
.rhythm main {
    --marge-active: 0;
    contain: unset;
    padding-block: 0;
    margin-block: 0;
}
*/

/* =========================== */
/* TYPOGRAPHIC NUANCES         */
/* =========================== */

.rhythm {
    /* Enhanced spacing relationships for typography */
    p {
        margin-block-start: 0;
    }

    h1 {
        margin: var(--space-xxxl) 0 var(--space-l) 0;
    }

    h2 {
        margin: var(--space-xxl) 0 var(--space-l) 0;
    }

    h3 {
        margin: var(--space-xl) 0 var(--space-l) 0;
    }

    h4 {
        margin: var(--space-l) 0 var(--space) 0;
    }

    h5 {
        margin: var(--space) 0 var(--space-s) 0;
    }

    h6 {
        margin: var(--space) 0 var(--space-xs) 0;
    }

    hr {
        margin-block-start: var(--space-xxl);
        margin-block-end: var(--space-l);
    }

    /* Heading after heading gets reduced spacing */
    h1 + h2,
    h2 + h3,
    h3 + h4,
    h4 + h5,
    h5 + h6 {
        margin-block-end: calc(var(--space-xs) * var(--rhythm-multiplier));
    }

    /* Lists after headings get normal spacing */
    h1 + ul,
    h1 + ol,
    h2 + ul,
    h2 + ol,
    h3 + ul,
    h3 + ol {
        margin-block-end: calc(var(--space) * var(--rhythm-multiplier));
    }

    /* Blockquotes get more generous spacing */
    blockquote {
        margin-block-start: calc(
            (var(--space-block-special) - var(--space)) *
                var(--rhythm-multiplier)
        );
        margin-block-end: calc(
            var(--space-block-special) * var(--rhythm-multiplier)
        );
        margin-inline-start: calc(
            var(--space-block-special) * var(--rhythm-multiplier)
        );
        margin-inline-end: calc(
            var(--space-block-special) * var(--rhythm-multiplier)
        );
    }

    /* Pre/code blocks need breathing room */
    pre {
        margin-block-start: calc(
            (var(--space-block-special) - var(--space)) *
                var(--rhythm-multiplier)
        );
        margin-block-end: calc(
            var(--space-block-special) * var(--rhythm-multiplier)
        );
    }

    /* Figure spacing for visual hierarchy */
    figure {
        margin-block-start: calc(
            (var(--space-block-special) - var(--space)) *
                var(--rhythm-multiplier)
        );
        margin-block-end: calc(
            var(--space-block-special) * var(--rhythm-multiplier)
        );
    }

    /* Paragraphs with images get special block spacing */
    p:has(img) {
        margin-block-start: calc(
            (var(--space-block-special) - var(--space)) *
                var(--rhythm-multiplier)
        );
        margin-block-end: calc(
            var(--space-block-special) * var(--rhythm-multiplier)
        );
    }
    p:has(img) + p:has(img) {
        --margin-to-remove: calc(
            (var(--space-block-special) * var(--rhythm-multiplier)) * -1
        );

        margin-block-start: calc(var(--margin-to-remove) + var(--space-gap));
        margin-block-end: calc(
            var(--space-block-special) * var(--rhythm-multiplier)
        );
    }

    /* Callouts get special block spacing */
    .callout {
        margin-block-start: calc(
            (var(--space-block-special) - var(--space)) *
                var(--rhythm-multiplier)
        );
        margin-block-end: calc(
            var(--space-block-special) * var(--rhythm-multiplier)
        );
    }

    /* Reset first-child spacing for special blocks */
    blockquote:first-child,
    pre:first-child,
    figure:first-child,
    fieldset:first-child,
    p:has(img):first-child,
    .callout:first-child {
        margin-block-start: 0;
    }

    /* Form elements get consistent but nuanced spacing */
    /* Form field groups - spacing only */
    fieldset {
        margin-block-start: calc((var(--space-block-special) - var(--space)));
        margin-block-end: var(--space-block-special);
    }

    /* =========================== */
    /* TYPOGRAPHY ELEMENTS         */
    /* =========================== */

    /* Typography-specific spacing adjustments */

    /* =========================== */
    /* CONTENT ELEMENTS            */
    /* =========================== */

    /* Lists */
    ul,
    ol {
        padding-inline-start: var(--space-l);
        list-style-position: outside;
    }

    /* Nested lists */
    li > ul,
    li > ol {
        padding-inline-start: var(--space);
    }

    /* List items spacing only */
    li {
        margin: 0;
    }

    /* List marker spacing only */
    ul > li::marker {
        display: inline-block;
        width: var(--space);
        margin-inline-start: var(--space);
    }

    ol {
        counter-reset: ol-counter;
    }

    ol > li::marker {
        display: inline-block;
        width: var(--space);
        margin-inline-start: var(--space);
    }

    /* Blockquotes - spacing only */
    blockquote {
        padding-inline-start: var(--space-l);
    }

    /* Code blocks - spacing only */
    pre {
        padding: calc(var(--space));
    }

    /* Horizontal rules - spacing only */
    hr {
        margin-inline: calc(var(--space-l) * var(--rhythm-multiplier));
    }

    /* =========================== */
    /* FORMS AND INTERACTIVE       */
    /* =========================== */

    /* Form containers - avoid nested grids */
    form:not(.grid *) {
        display: grid;
        gap: calc(var(--space-s) * var(--rhythm-multiplier));
    }

    /* Forms inside grids use flex layout to avoid nesting issues */
    .grid form {
        display: flex;
        flex-direction: column;
        gap: calc(var(--space-s) * var(--rhythm-multiplier));
    }

    /* Form field groups - spacing only */
    fieldset {
        padding: calc(var(--space-s) * var(--rhythm-multiplier));
        display: grid;
        gap: calc(var(--space-xs) * var(--rhythm-multiplier));
    }

    legend {
        padding-inline: calc(var(--space-xs) * var(--rhythm-multiplier));
    }

    /* Form inputs */
    input,
    textarea,
    select {
        margin: 0;
    }

    /* Labels - spacing only */
    label {
        margin: 0;
    }

    /* Label + input pairs */
    label:has(+ input),
    label:has(+ textarea),
    label:has(+ select) {
        margin-block-end: calc(var(--space-xs) * var(--rhythm-multiplier));
    }

    /* Checkbox/radio with labels */
    input[type="checkbox"],
    input[type="radio"] {
        margin-inline-end: calc(var(--space-xs) * var(--rhythm-multiplier));
    }

    /* Button groups */
    .button-group {
        display: flex;
        gap: calc(var(--space-s) * var(--rhythm-multiplier));
        flex-wrap: wrap;
    }

    /* =========================== */
    /* MEDIA ELEMENTS              */
    /* =========================== */

    /* Images, videos, etc. */
    img,
    video,
    audio,
    iframe {
        max-width: 100%;
        height: auto;
    }

    /* Figures */
    figure {
        display: grid;
        gap: calc(var(--space-xs) * var(--rhythm-multiplier));
    }

    figcaption {
        /* Spacing handled by rhythm system */
    }

    /* =========================== */
    /* TABLES                      */
    /* =========================== */

    table {
        width: 100%;
    }

    th,
    td {
        padding: calc(var(--space-xs) * var(--rhythm-multiplier))
            calc(var(--space-s) * var(--rhythm-multiplier));
    }

    th {
        /* Typography and colors handled elsewhere */
    }

    caption {
        margin-block-end: calc(var(--space-xs) * var(--rhythm-multiplier));
    }

    /* =========================== */
    /* COMPONENTS & CUSTOM         */
    /* =========================== */

    /* Callouts and special components - spacing only */
    .callout {
        padding: calc(var(--space) * var(--rhythm-multiplier));
        display: grid;
        gap: calc(var(--space-s) * var(--rhythm-multiplier));
    }

    .callout-title {
        margin: 0;
    }

    .callout-content {
        margin: 0;
    }
}

/* Common layout containers inherit rhythm to cascade deeper */
.box,
.grid > .col-1,
.grid > .col-2,
.grid > .col-3,
.grid > .col-4,
.grid > .col-5,
.grid > .col-6,
.grid > .col-7,
.grid > .col-8,
.grid > .col-9,
.grid > .col-10,
.grid > .col-11,
.grid > .col-12,
.grid > .col-half,
.grid > .col-third,
.grid > .col-two3,
.grid > .col-quarter,
.grid > .col-full {
    > * {
        margin-block: 0;
        margin-block-end: calc(var(--space-block) * var(--rhythm-multiplier));
    }

    > :last-child {
        margin-block-end: 0;
    }

    > :first-child {
        margin-block-start: 0;
    }
}

/* =========================== */
/* UTILITY CLASSES            */
/* =========================== */

/* Spacing override utilities */
.rhythm-tight {
    --rhythm-multiplier: 0.75;
}

.rhythm-loose {
    --rhythm-multiplier: 1.5;
}

.rhythm-xl {
    --rhythm-multiplier: 2;
}

/* Individual element overrides */
.no-rhythm {
    margin: 0 !important;
}

.no-block-start {
    margin-block-start: 0 !important;
}

.no-block-end {
    margin-block-end: 0 !important;
}

.stick-next {
    margin-block-end: calc(
        var(--space-xs) * var(--rhythm-multiplier)
    ) !important;
}

/* =========================== */
/* PERFORMANCE OPTIMIZATIONS  */
/* =========================== */

/* Reduce repaints and reflows */
.rhythm {
    /* Use GPU acceleration for transforms if needed */
    /*transform: translateZ(0); */

    /* Optimize for animations */
    /*will-change: auto; */
}

/* =========================== */
/* ACCESSIBILITY               */
/* =========================== */

/* Ensure rhythm doesn't interfere with screen readers */
.rhythm:focus-within {
    /* Maintain focus visibility */
}

/* Respect user motion preferences */
@media (prefers-reduced-motion: reduce) {
    .rhythm {
        transition: none;
    }
}

/* =========================== */
/* LEGACY SUPPORT             */
/* =========================== */

/* Fallback for browsers without CSS Grid support */
@supports not (display: grid) {
    .rhythm {
        display: block;

        > * {
            margin-block-end: calc(
                var(--space-block) * var(--rhythm-multiplier)
            );
        }

        > :last-child {
            margin-block-end: 0;
        }
    }
}

---
import Base from '../astro/layouts/Base.astro';
import Meta from '../astro/layouts/Meta.astro';
import Encrypted from '../astro/layouts/Encrypted.astro';

export async function getStaticPaths() {
  const pages = import.meta.glob('/content/**/*.md', { eager: true });

  return Object.keys(pages).map((path) => {
    // Remove /content/ prefix and .md extension
    let slug = path.replace('/content/', '').replace('.md', '');
    
    // Handle index files
    if (slug === 'readme') {
        // readme.md is handled by index.astro, but we might want it here too?
        // Usually index.astro takes precedence.
        // Let's skip it if we want, or map it.
        // The user has index.astro rendering readme.md.
        slug = undefined; // This might be tricky.
    }
    
    if (slug && slug.endsWith('/index')) {
      slug = slug.replace('/index', '');
    }
    
    if (slug === 'index') {
      slug = undefined;
    }

    return {
      params: { slug },
      props: { page: pages[path], path },
    };
  }).filter(p => p.params.slug !== 'readme'); // Filter out readme if needed
}

const { page, path } = Astro.props;
const { Content, frontmatter } = page;

// Map 11ty layouts to Astro layouts
const layoutMap = {
  'base.njk': Base,
  'layouts/base.njk': Base,
  'layouts/main.njk': Base,
  'layouts/blog-post.njk': Base,
  'layouts/article.njk': Base,
  'layouts/card.njk': Base,
  'minimal': Base,
  'default': Base,
  'blog-post': Base,
  'lesson': Base,
  'comments.njk': Base,
  'layouts/meta.njk': Meta,
  'meta.njk': Meta,
  'layouts/encrypted.njk': Encrypted,
  'encrypted.njk': Encrypted,
};

// Determine layout
// Default to Base if not specified or not found
// We check 'legacy_layout' because our remark plugin renamed 'layout' to avoid Astro resolving it.
const layoutName = frontmatter.legacy_layout || frontmatter.layout;
const Layout = layoutMap[layoutName] || Base;

// Prepare site data (mocking 11ty global data for now, or importing it)
// Ideally we should import the real site data
const site = {
  title: "Standard Framework",
  description: "A fine-art typography framework.",
  language: "en",
  author: { name: "Francis Fontaine" },
  url: "http://localhost:8083",
  nav: {
    header: [
      { title: "Home", url: "/" },
      { title: "About", url: "/about" },
      { title: "External", url: "https://example.com", external: true }
    ]
  }
};
---

<Layout site={site} {...frontmatter}>
  <Content />
</Layout>

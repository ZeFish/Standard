---
import { getExcerpt } from "@zefish/standard/astro/utils";

// Access site configuration from global
const config = globalThis['__STANDARD_CONFIG__'] as any;

const {
    frontmatter,
    site = config.site || config, // Use config.site if available, fallback to config
    page = {},
    title = frontmatter?.title || config.title,
    description = frontmatter?.description || config.description,
    image = frontmatter?.image,
    created = frontmatter?.created,
    modified = frontmatter?.modified,
    tags = frontmatter?.tags,
    securityHeaders = frontmatter?.securityHeaders,
} = Astro.props;


const fullTitle =
    title && title !== site.title ? `${title} Â· ${site.title}` : site.title;

// Ensure we have a valid base URL
const baseUrl = site.url || config.url || Astro.site || 'http://localhost:4321';
const pageUrl = new URL(Astro.url.pathname, baseUrl);
const canonicalUrl = new URL(
    Astro.url.pathname.replace(/index\.html$/, ""),
    baseUrl,
);

// Description logic
const pageExcerpt = page.rawInput ? String(page.rawInput) : "";
const metaDescription =
    description ||
    getExcerpt(pageExcerpt, { maxChars: 150 }) ||
    site.description ||
    "";

// Image logic
const imageUrl = image
    ? `${site.url}/assets/img/${image}`
    : `${site.url}/assets/img/default.png`; // Fallback needed?
// Note: 11ty used a filter extractFirstImage. We might need to pass the image explicitly in Astro or parse content.
// For now, we'll assume 'image' prop is passed or we default.
// If we want to support extractFirstImage, we'd need the raw content here.

const imageAlt = image ? title : site.title;

// Date logic
const datePublished = created ? new Date(created).toISOString() : null;
const dateModified =
    modified || created ? new Date(modified || created).toISOString() : null;

const authorName = site.author?.name || site.author;
const twitterUsername = site.twitter_username || "francisfontaine";
---

<meta charset="utf-8" />
<!-- Standard Framework | https://standard.ffp.co -->

<title>{fullTitle}</title>
<meta name="description" content={metaDescription} />
<meta name="author" content={authorName} />
<meta name="language" content={site.language || "en"} />
<meta name="referrer" content="strict-origin-when-cross-origin" />

<!-- Canonical URL -->
<link rel="canonical" href={canonicalUrl} />

<!-- Feed & Sitemap -->
<link
    rel="alternate"
    type="application/atom+xml"
    title={site.title}
    href={`${site.url}/feed.xml`}
/>
<link
    rel="sitemap"
    type="application/xml"
    title="Sitemap"
    href={`${site.url}/sitemap.xml`}
/>

{
    securityHeaders && (
        <>
            <meta
                http-equiv="Content-Security-Policy"
                content={securityHeaders.csp}
            />
            <meta
                http-equiv="Referrer-Policy"
                content={securityHeaders.referrerPolicy}
            />
            <meta
                http-equiv="Permissions-Policy"
                content={securityHeaders.permissions}
            />
            <meta
                http-equiv="X-Content-Type-Options"
                content={securityHeaders.xContentTypeOptions}
            />
        </>
    )
}

<!-- Robots Meta -->
{
    site.visibility === "private" ? (
        <meta name="robots" content="noindex, nofollow" />
    ) : (
        <meta
            name="robots"
            content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1"
        />
    )
}

<!-- Open Graph -->
<meta property="og:title" content={title || site.title} />
<meta property="og:type" content={title ? "article" : "website"} />
<meta property="og:locale" content={site.language || "en"} />
<meta property="og:site_name" content={site.title} />
<meta property="og:url" content={pageUrl} />
<meta property="og:description" content={metaDescription} />

<meta property="og:image" content={imageUrl} />
<meta property="og:image:alt" content={imageAlt} />
<meta property="og:image:width" content="1200" />
<meta property="og:image:height" content="630" />

{
    datePublished && (
        <>
            <meta property="article:published_time" content={datePublished} />
            <meta property="article:author" content={authorName} />
            {tags &&
                tags.map((tag: string) => (
                    <meta property="article:tag" content={tag} />
                ))}
        </>
    )
}

<!-- Twitter Cards -->
<meta name="twitter:card" content={image ? "summary_large_image" : "summary"} />
<meta name="twitter:image" content={imageUrl} />
<meta name="twitter:image:alt" content={imageAlt} />
<meta name="twitter:site" content={`@${twitterUsername}`} />
<meta name="twitter:creator" content={`@${twitterUsername}`} />
<meta name="twitter:title" content={fullTitle} />
<meta name="twitter:description" content={metaDescription} />

<!-- Schema.org -->
<script
    type="application/ld+json"
    set:html={JSON.stringify({
        "@context": "https://schema.org",
        "@type": title ? "BlogPosting" : "WebSite",
        ...(title
            ? {
                  headline: title,
                  description: metaDescription,
                  author: {
                      "@type": "Person",
                      name: authorName,
                      url: `${site.url}/now/`,
                  },
                  publisher: {
                      "@type": "Person",
                      name: authorName,
                      url: site.url,
                      logo: {
                          "@type": "ImageObject",
                          url: `${site.url}/francis-fontaine-avatar.png`,
                      },
                  },
                  ...(datePublished && { datePublished: datePublished }),
                  ...(dateModified && { dateModified: dateModified }),
                  image: {
                      "@type": "ImageObject",
                      url: imageUrl,
                      width: 1200,
                      height: 630,
                  },
                  mainEntityOfPage: {
                      "@type": "WebPage",
                      "@id": pageUrl,
                  },
              }
            : {
                  name: site.title,
                  description: site.description,
                  url: site.url,
                  author: {
                      "@type": "Person",
                      name: authorName,
                      url: site.url,
                  },
              }),
    })}
/>

<!-- Favicons -->
<link
    rel="apple-touch-icon"
    sizes="180x180"
    href={`${site.url}/favicons/apple-touch-icon.png`}
/>
<link
    rel="icon"
    type="image/png"
    sizes="32x32"
    href={`${site.url}/favicons/favicon-32x32.png`}
/>
<link
    rel="icon"
    type="image/png"
    sizes="16x16"
    href={`${site.url}/favicons/favicon-16x16.png`}
/>
<link rel="manifest" href="/site.webmanifest" />
<link
    rel="mask-icon"
    href={`${site.url}/favicons/safari-pinned-tab.svg`}
    color="#000000"
/>
<link rel="shortcut icon" href={`${site.url}/favicons/favicon.ico`} />

<!-- Mobile -->
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="mobile-web-app-capable" content="yes" />
<meta
    name="apple-mobile-web-app-status-bar-style"
    content="black-translucent"
/>
<meta
    name="theme-color"
    content="#ffffff"
    media="(prefers-color-scheme: light)"
/>
<meta
    name="theme-color"
    content="#000000"
    media="(prefers-color-scheme: dark)"
/>

<!-- Windows Tiles -->
<meta name="msapplication-TileColor" content="#000000" />
<meta
    name="msapplication-config"
    content={`${site.url}/favicons/browserconfig.xml`}
/>

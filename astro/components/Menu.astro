---
/**
 * Menu Component
 * Displays navigation items from site.config.yml with proper active states
 */
import config from "virtual:standard/config";

const {
    items = config.nav?.header || [],
    ariaLabel = "Navigation",
    class: className = "",
    limit,
} = Astro.props;

// Ensure items is always an array
const safeItems = Array.isArray(items) ? items : [];

// Get current URL safely
const currentUrl = Astro.url?.pathname || "/";

function normalizePath(p = "") {
    if (!p) return "/";
    const s = String(p).replace(/\/+$/, "");
    return s === "" ? "/" : s;
}

function isActive(itemUrl, currentUrl, exact = false) {
    const a = normalizePath(itemUrl);
    const b = normalizePath(currentUrl);
    return exact ? a === b : b.startsWith(a);
}

const itemsToRender =
    limit && limit > 0 ? safeItems.slice(0, limit) : safeItems;
---

<nav class:list={["menu", className]} aria-label={ariaLabel}>
    <ul class="menu">
        {
            itemsToRender.length > 0 ? (
                itemsToRender.map((item) => {
                    if (!item || typeof item !== "object") {
                        return null;
                    }

                    const href = item.url || "#";
                    const active = isActive(href, currentUrl, item.exact);
                    const isAbsolute = /^https?:\/\//i.test(href);
                    const siteUrl = Astro.site ? Astro.site.toString() : "";
                    const external =
                        item.external ||
                        (isAbsolute &&
                            !href.startsWith(normalizePath(siteUrl)));
                    const rel =
                        item.rel ||
                        (external ? "noopener noreferrer" : undefined);
                    const target =
                        item.target || (external ? "_blank" : undefined);

                    return (
                        <li
                            class:list={["menu__item", { "is-active": active }]}
                        >
                            <a
                                class:list={[
                                    "menu__link",
                                    { "external-link": external },
                                ]}
                                href={href}
                                aria-current={active ? "page" : undefined}
                                target={target}
                                rel={rel}
                            >
                                {item.title ||
                                    item.label ||
                                    item.text ||
                                    "Untitled"}
                            </a>
                        </li>
                    );
                })
            ) : (
                <li class="menu__item">
                    <a href="/" class="menu__link">
                        Home
                    </a>
                </li>
            )
        }
    </ul>
</nav>

---
import { getCollection, render } from "astro:content";
import Base from "../layouts/Base.astro";

import config from "virtual:standard/config";
import { generatePermalink } from "../utils/permalink.js";

// This function generates all the static paths for our .md files
export async function getStaticPaths() {
  // Load the 'docs' collection defined in src/content/config.ts
  const docs = await getCollection("content");

  return docs.map((entry) => {
    // Get permalink from frontmatter OR generate it using shared utility
    // (Remark plugins run too late for getStaticPaths, so we must ensure it exists here)
    const permalink = entry.data.permalink || generatePermalink(entry.id);

    // Convert permalink to a valid Astro slug (remove leading/trailing slashes)
    const slug = permalink.replace(/^\/|\/$/g, "");

    // Empty string/undefined for index file (/) - this becomes the root route
    return {
      params: { slug: slug || undefined },
      props: { entry },
    };
  });
}

// Get the entry from props
const { entry } = Astro.props;
const { Content } = await render(entry);
---

<!-- Use Base layout and pass the markdown content through -->
<Base>
  <Content />
</Base>

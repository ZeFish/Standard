@use "standard-00-variables" as *;

/**
 * @component Vertical Rhythm System
 * @category Layout
 * @description Enhanced bulletproof rhythm system that prevents margin collapse
 * and ensures consistent vertical spacing throughout the document. Based on the
 * 1rlh (relative line height) rhythm unit for mathematical precision.
 * Applied globally to <html> root for cascade throughout the page.
 * Supports responsive rhythm adjustments and granular control per element.
 *
 * @prop {class} .rhythm Apply rhythm spacing to <html> root or any container
 * @prop {class} .no-rhythm Disable rhythm for specific elements
 * @prop {variable} --base Base rhythm unit (1rlh)
 * @prop {variable} --base-gap Normal element spacing multiplier (default: 1)
 * @prop {variable} --base-block-gap Block element spacing multiplier
 * @prop {variable} --body-padding Padding multiplier for <body> (desktop)
 * @prop {variable} --body-mobile-padding-multiplier Padding multiplier for <body> (mobile)
 *
 * @example
 * // Global: <html> has .rhythm class (applied automatically)
 * <html class="rhythm">
 *   <body>
 *     <!-- All content gets rhythm spacing -->
 *     <h1>Title</h1>
 *     <p>Paragraphs get automatic spacing</p>
 *   </body>
 * </html>
 *
 * // Local: Apply .rhythm to specific container
 * <div class="rhythm">
 *   <h1>Section Title</h1>
 *   <p>Container children get rhythm spacing</p>
 * </div>
 *
 * // Disable: Use .no-rhythm to opt-out
 * <section class="no-rhythm">No spacing applied here</section>
 * <div class="rhythm no-rhythm">Explicitly disabled rhythm</div>
 *
 * @since 0.1.0
 * @see standard-01-token.scss
 * @see standard-06-reading.scss
 */

/* Enhanced Bulletproof Rhythm System - Margin Collapse Safe */

/* ===== Harmony Base (containers and resets) ===== */
:where(*, *::before, *::after) {
  box-sizing: border-box;
}

/* ===== BULLETPROOF RHYTHM SYSTEM ===== */
/* Applied to <html> root for global cascade (best practice for frameworks) */
:where(.rhythm) {
  /* Rhythm control - can be overridden per instance */
  display: inline-flex;
  align-items: baseline;

  /* Modern margin collapse prevention */
  display: flow-root;

  /* Apply rhythm spacing to all direct children */
  * {
    vertical-align: baseline;
    margin-block-start: 0;
    margin-block-end: var(--base);
  }

  /* Padding only applied to <body> when rhythm is active */
  > body {
    margin: 0;
    padding: var(--gap-body);
    padding-bottom: calc(var(--gap-body) * 1.5);

    [id] {
      scroll-margin-top: calc(var(--base-2) + var(--gap-body));
      /* Adjust value as needed */
    }
  }

  /* Elements within rhythm containers */
  /* Enhanced spacing relationships for typography */
  #{$rhythm-elements} {
    margin-block-start: 0;
    margin-block-end: var(--base);
  }

  /* Special blocks get generous spacing (2× rhythm) */
  /* Layout containers get double spacing for emphasis */
  #{$rhythm-block-elements} {
    margin-block-start: max(calc(var(--base-2) - var(--base)), var(--base));
    margin-block-end: max(var(--base-2), var(--base));
  }

  /* The i that two specal block would bit a bit closer
    debug when  its image */
  :is(#{$rhythm-block-elements}):has(+ :is(#{$rhythm-block-elements})) {
    margin-block-end: var(--base);
  }

  :is(#{$rhythm-block-elements}) + :is(#{$rhythm-block-elements}) {
    margin-block-start: max(0, var(--base));
  }

  /* Reset first-child spacing for special blocks */
  :is(.card, aside, blockquote, pre, figure, .callout-content) > :first-child {
    margin-block-start: 0;
  }

  * > :last-child {
    margin-block-end: 0;
  }

  .rhythm {
    --base-gap: 1;
    /* Reset for nested contexts */
  }

  h1 {
    margin-block-start: calc(var(--base) * 3);
    margin-block-end: var(--base);
  }
  h1:first-of-type {
    margin-block-start: calc(var(--base) * 5);
    margin-block-end: calc(var(--base) * 6);
  }

  h2,
  h3 {
    margin-block-start: calc(var(--base) * 2);
    margin-block-end: var(--base);
  }

  h4,
  h5,
  h6 {
    margin-block: calc(var(--leading) * 2);
  }

  :is(h1, h2, h3) + :is(h1, h2, h3),
  hr + :is(h1, h2, h3) {
    margin-block-start: 0;
  }

  hr {
    margin-inline: calc(var(--base-4));
    margin-block-start: max(
      calc((var(--base-2) - var(--base)) * 1),
      var(--base)
    );
    margin-block-end: max((var(--base-2) * 1), var(--base));
  }

  /* =========================== */
  /* TYPOGRAPHY ELEMENTS         */
  /* =========================== */

  /* Typography-specific spacing adjustments */

  /* =========================== */
  /* CONTENT ELEMENTS            */
  /* =========================== */

  /* Lists */

  ul,
  ol {
    list-style: none;
    margin-block-start: 0;
    padding-inline: 1rlh;
    margin-block-end: var(--base);
  }

  /* Nested lists */
  li > ul,
  li > ol {
    padding-inline-start: 1rlh;
    margin-block-start: var(--trim);
    margin-block-end: 0;
  }

  /* List items */
  li {
    position: relative;
    margin: 0;
    padding-inline-start: 0;
    margin-block-end: calc((1lh - 1em) * 3);
  }

  li:last-child {
    /* should be manage in the general last-chuld rule */
    margin-block-end: 0;
  }

  p:has(+ :is(ul, ol)) {
    margin-block-end: calc((1lh - 1em) * 3);
  }

  .compact {
    --base-gap: var(--leading);

    li {
      margin-block-end: var(--leading);
    }
  }

  .tight {
    --base-gap: var(--trim);

    li {
      margin-block-end: var(--trim);
    }
  }

  .relaxed {
    --base-gap: var(--base-2);

    li {
      margin-block-end: var(--base-2);
    }
  }

  /* Unordered list bullets */
  ul > li::before {
    content: "•";
    position: absolute;
    top: 0;
    left: calc(1rlh * -1);
    width: 1rlh;
    text-align: center;
    color: var(--color-subtle);
  }

  /* Ordered list numbers */
  ol {
    counter-reset: ol-counter;
  }

  ol > li {
    counter-increment: ol-counter;
  }

  ol > li::before {
    content: counter(ol-counter) ".";
    position: absolute;
    left: calc((1rlh * -1) - var(--leading));
    text-align: right;
    color: var(--color-subtle);
    font-variant-numeric: tabular-nums;
    width: 1rlh;
    font-size: var(--scale-d2);
  }

  /* Inline lists - remove margin-bottom from list items */
  ul:where(.display-flex, [style*="display: flex"], [style*="display:flex"]) li,
  ol:where(.display-flex, [style*="display: flex"], [style*="display:flex"])
    li {
    margin-block-end: 0;
  }

  /* =========================== */
  /* FORMS AND INTERACTIVE       */
  /* =========================== */

  /* Form containers - avoid nested grids */
  form:not(.grid *) {
    display: grid;
    gap: calc(var(--base) * var(--base-gap));
  }

  /* Forms inside grids use flex layout to avoid nesting issues */
  .grid form {
    display: flex;
    flex-direction: column;
    gap: calc(var(--base) * var(--base-2));
  }

  /* Form field groups - spacing only */
  fieldset {
    padding-inline: var(--base);
    display: grid;
    gap: 0;
  }

  legend {
    margin-block-end: var(--base);
  }

  /* Form inputs */
  input,
  textarea,
  select {
    padding-inline: var(--base);
    margin-block-end: var(--base-2);
  }

  /* Labels - spacing only */
  label {
    margin-inline: var(--base);
    margin-block-end: var(--base-2);
  }

  /* Checkbox/radio with labels */
  input[type="checkbox"] + label,
  input[type="radio"] + label {
    margin-inline-start: var(--leading);
  }

  div:has(input + label) {
    margin-block-end: var(--base-2);
  }

  fieldset div,
  fieldset p {
    margin: 0;
    padding: 0;
  }

  fieldset + button {
    margin-block-start: var(--base);
  }

  fieldset :last-child {
    margin-block-end: 0;
  }

  /* =========================== */
  /* MEDIA ELEMENTS              */
  /* =========================== */

  /* Images, videos, etc. */
  img,
  video,
  audio,
  iframe {
    max-width: 100%;
    height: auto;
  }

  /* Figures */
  figure {
    display: grid;
    gap: calc(var(--base-d4) * var(--base-gap));
  }

  /* Spacing handled by rhythm system */
  /* figcaption {} */
  /* =========================== */
  /* TABLES                      */
  /* =========================== */

  caption {
    margin-block-end: calc(var(--base-d4) * var(--base-gap));
  }

  /* Swiss-style data tables */
  table {
    /* You already have: border-collapse: collapse; */
    width: 100%;
    /* font-variant-numeric: tabular-nums;*/
    /* ADD: Monospace numbers */
  }

  td,
  th {
    padding: var(--leading);
    font-size: var(--scale-d2);
    min-height: var(--line-height);
  }

  th {
    /* You already have: text-align: left; font-weight: bold; */
    text-transform: uppercase;
    /* ADD */
    letter-spacing: 0.05em;
    /* ADD */
  }

  /* ADD: Numeric column alignment */
  .numeric {
    text-align: right;
    font-variant-numeric: tabular-nums;
  }

  /* ADD: Zebra striping (functional, not decorative) */
  .striped tbody tr:nth-child(even) {
    background: color-mix(in srgb, var(--color-foreground) 3%, transparent);
  }
}

/* =========================== */
/* UTILITY CLASSES            */
/* =========================== */

/* Spacing override utilities */
.rhythm-compact {
  --base-gap: 0.5;
}

.rhythm-relaxed {
  --base-gap: 1.5;
}

.rhythm-xl {
  --base-gap: 2;
}

/* Individual element overrides */
.no-rhythm {
  margin: 0 !important;
}

.no-block-start {
  margin-block-start: 0 !important;
}

.no-block-end {
  margin-block-end: 0 !important;
}

.stick-next {
  margin-block-end: calc(var(--base-d4) * var(--base-gap)) !important;
}

/* =========================== */
/* PERFORMANCE OPTIMIZATIONS  */
/* =========================== */

/* Reduce repaints and reflows */
/* .rhythm {
    /* Use GPU acceleration for transforms if needed */
/*transform: translateZ(0); */

/* Optimize for animations */
/*will-change: auto; */
/* } */

/* =========================== */
/* ACCESSIBILITY               */
/* =========================== */

/* Ensure rhythm doesn't interfere with screen readers */
/* .rhythm:focus-within {
    /* Maintain focus visibility */
/* } */

/* Respect user motion preferences */
@media (prefers-reduced-motion: reduce) {
  .rhythm {
    transition: none;
  }
}

/* =========================== */
/* LEGACY SUPPORT             */
/* =========================== */

/* Fallback for browsers without CSS Grid support */
@supports not (display: grid) {
  .rhythm {
    display: block;

    > * {
      margin-block-end: var(--base-gap);
    }

    > :last-child {
      margin-block-end: 0;
    }
  }
}

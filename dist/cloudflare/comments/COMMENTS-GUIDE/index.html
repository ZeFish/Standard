<!DOCTYPE html><!-- Use Base layout and pass the markdown content through --><html class="rhythm" lang="en" data-theme="default"> <head><meta charset="utf-8"><!-- Standard Framework | https://standard.ffp.co --><title>Standard Framework</title><meta name="description" content="Standard is built on the belief that design systems should be rooted in centuries of typographic tradition, mathematical precision, and the timeless principles of Swiss International Style."><meta name="author" content="Francis Fontaine"><meta name="language" content="en"><meta name="referrer" content="strict-origin-when-cross-origin"><!-- Canonical URL --><link rel="canonical" href="https://standard.ffp.co/cloudflare/comments/COMMENTS-GUIDE/"><!-- Feed & Sitemap --><link rel="alternate" type="application/atom+xml" title="Standard Framework" href="https://standard.ffp.co/feed.xml"><link rel="sitemap" type="application/xml" title="Sitemap" href="https://standard.ffp.co/sitemap.xml"><!-- Robots Meta --><meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1"><!-- Open Graph --><meta property="og:title" content="Standard Framework"><meta property="og:type" content="article"><meta property="og:locale" content="en"><meta property="og:site_name" content="Standard Framework"><meta property="og:url" content="https://standard.ffp.co/cloudflare/comments/COMMENTS-GUIDE/"><meta property="og:description" content="Standard is built on the belief that design systems should be rooted in centuries of typographic tradition, mathematical precision, and the timeless principles of Swiss International Style."><meta property="og:image" content="https://standard.ffp.co/assets/img/default.png"><meta property="og:image:alt" content="Standard Framework"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"><!-- Twitter Cards --><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://standard.ffp.co/assets/img/default.png"><meta name="twitter:image:alt" content="Standard Framework"><meta name="twitter:site" content="@francisfontaine"><meta name="twitter:creator" content="@francisfontaine"><meta name="twitter:title" content="Standard Framework"><meta name="twitter:description" content="Standard is built on the belief that design systems should be rooted in centuries of typographic tradition, mathematical precision, and the timeless principles of Swiss International Style."><!-- Schema.org --><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","headline":"Standard Framework","description":"Standard is built on the belief that design systems should be rooted in centuries of typographic tradition, mathematical precision, and the timeless principles of Swiss International Style.","author":{"@type":"Person","name":"Francis Fontaine","url":"https://standard.ffp.co/now/"},"publisher":{"@type":"Person","name":"Francis Fontaine","url":"https://standard.ffp.co","logo":{"@type":"ImageObject","url":"https://standard.ffp.co/francis-fontaine-avatar.png"}},"image":{"@type":"ImageObject","url":"https://standard.ffp.co/assets/img/default.png","width":1200,"height":630},"mainEntityOfPage":{"@type":"WebPage","@id":"https://standard.ffp.co/cloudflare/comments/COMMENTS-GUIDE/"}}</script><!-- Favicons --><link rel="apple-touch-icon" sizes="180x180" href="https://standard.ffp.co/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://standard.ffp.co/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://standard.ffp.co/favicons/favicon-16x16.png"><link rel="manifest" href="/site.webmanifest"><link rel="mask-icon" href="https://standard.ffp.co/favicons/safari-pinned-tab.svg" color="#000000"><link rel="shortcut icon" href="https://standard.ffp.co/favicons/favicon.ico"><!-- Mobile --><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)"><meta name="theme-color" content="#000000" media="(prefers-color-scheme: dark)"><!-- Windows Tiles --><meta name="msapplication-TileColor" content="#000000"><meta name="msapplication-config" content="https://standard.ffp.co/favicons/browserconfig.xml"><link rel="preconnect" href="https://rsms.me/"><link rel="stylesheet" href="https://rsms.me/inter/inter.css"><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;1,100;1,200;1,300;1,400;1,500;1,600;1,700&family=Source+Serif+4:ital,opsz,wght@0,8..60,200..900;1,8..60,200..900&display=swap" rel="stylesheet"><!-- Standard Framework Lab Features --><script src="/assets/standard/standard.lab.js?v=1764047976402"></script><!-- Load HTMX library --><script type="module" src="/_astro/Base.astro_astro_type_script_index_0_lang.C1onTupY.js"></script><link rel="stylesheet" href="https://use.typekit.net/epz8pgr.css"><!-- ✅ FIX: Load scripts only on client side --><script type="module">
            import "/assets/js/standard.js";
            // import "/assets/js/standard.lab.js"; // Removed - Lab component handles this
            import "/assets/js/standard.toast.js";
            import "/assets/js/standard.comment.js";
        </script><link rel="stylesheet" href="/_astro/_slug_.dcmf1oDl.css"><script type="module" src="/_astro/page.DXhROYzO.js"></script></head> <body hx-boost="true" hx-ext="preload" hx-target="body" hx-swap="innerHTML scroll:window:top" class="prose"> <a href="#main" class="skip-link">Skip to content</a> <header class="flex font-interface" style="justify-content: space-between; max-width: 100%;"> <p> <a href="/" style="text-decoration: none;">Standard Framework</a> </p> <nav class="menu horizontal" aria-label="Navigation"> <ul class="menu"> <li class="menu__item"> <a class="menu__link" href="/docs/"> Docs </a> </li><li class="menu__item"> <a class="menu__link" href="/getting-started/"> Getting Started </a> </li><li class="menu__item"> <a class="menu__link" href="/cheat-sheet/"> Cheat Sheet </a> </li> </ul> </nav> </header> <main id="main" class="prose">  <h1 id="github-comments-system">GitHub Comments System</h1>
<p>A serverless comments system that stores each comment as a file in your GitHub repository. Perfect for static sites, blogs, and documentation that need user engagement without complex backends.</p>
<h2 id="howitworks">How It Works</h2>
<pre class="language-plaintext" data-language="plaintext"><code is:raw="" class="language-plaintext">User submits comment via form
         ↓
Cloudflare Function validates &#x26; sanitizes
         ↓
Spam detection checks comment
         ↓
Comment stored as JSON file in GitHub
         ↓
Browser fetches comments and renders
</code></pre>
<p><strong>Key Features:</strong></p>
<ul>
<li>✅ Each comment = 1 file in GitHub (easy to manage/review)</li>
<li>✅ Automatic spam detection with configurable thresholds</li>
<li>✅ Moderation workflow (approval before displaying)</li>
<li>✅ Nested/threaded comments support</li>
<li>✅ Email notifications for new comments</li>
<li>✅ Rate limiting per IP address</li>
<li>✅ Markdown and link support</li>
<li>✅ Mobile-friendly rendering</li>
</ul>
<h2 id="setup">Setup</h2>
<h3 id="1-github-repository-setup">1. GitHub Repository Setup</h3>
<ol>
<li>
<p>Create a directory for comments in your repo:</p>
<pre class="language-bash" data-language="bash"><code is:raw="" class="language-bash"><span class="token function">mkdir</span> data/comments</code></pre>
</li>
<li>
<p>Create a Personal Access Token:</p>
<ul>
<li>Go to GitHub Settings → Developer settings → Personal access tokens</li>
<li>Click “Generate new token (classic)”</li>
<li>Select scopes: <code>repo</code> (full control of repositories)</li>
<li>Copy the token (you’ll need it for Cloudflare)</li>
</ul>
</li>
<li>
<p>Commit the empty directory:</p>
<pre class="language-bash" data-language="bash"><code is:raw="" class="language-bash"><span class="token function">git</span> <span class="token function">add</span> data/comments/.gitkeep
<span class="token function">git</span> commit <span class="token parameter variable">-m</span> <span class="token string">“Add comments directory”</span>
<span class="token function">git</span> push</code></pre>
</li>
</ol>
<h3 id="2-cloudflare-configuration">2. Cloudflare Configuration</h3>
<ol>
<li>
<p>Set environment variables in <code>wrangler.toml</code>:</p>
<pre class="language-toml" data-language="toml"><code is:raw="" class="language-toml"><span class="token punctuation">[</span><span class="token table class-name">env.production</span><span class="token punctuation">]</span>
<span class="token key property">vars</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span> <span class="token key property">SPAM_CHECK_ENABLED</span> <span class="token punctuation">=</span> <span class="token string">“true”</span> <span class="token punctuation">}</span>

<span class="token punctuation">[</span><span class="token table class-name">env.production.secrets</span><span class="token punctuation">]</span>
<span class="token comment"># Run: wrangler secret put GITHUB_TOKEN</span>
<span class="token key property">GITHUB_TOKEN</span> <span class="token punctuation">=</span> <span class="token string">“your-personal-access-token”</span>
<span class="token key property">GITHUB_OWNER</span> <span class="token punctuation">=</span> <span class="token string">“your-username-or-org”</span>
<span class="token key property">GITHUB_REPO</span> <span class="token punctuation">=</span> <span class="token string">“your-repo-name”</span>
<span class="token key property">GITHUB_COMMENTS_PATH</span> <span class="token punctuation">=</span> <span class="token string">“data/comments”</span>
<span class="token key property">MODERATION_EMAIL</span> <span class="token punctuation">=</span> <span class="token string">“§§EMAIL§§25§§”</span>
<span class="token key property">GITHUB_WEBHOOK_SECRET</span> <span class="token punctuation">=</span> <span class="token string">“your-webhook-secret”</span>
</code></pre>
</li>
<li>
<p>Add secrets to Cloudflare:</p>
<pre class="language-bash" data-language="bash"><code is:raw="" class="language-bash">wrangler secret put GITHUB_TOKEN
wrangler secret put GITHUB_OWNER
wrangler secret put GITHUB_REPO</code></pre>
</li>
<li>
<p>Deploy function:</p>
<pre class="language-bash" data-language="bash"><code is:raw="" class="language-bash">wrangler publish <span class="token parameter variable">–env</span> production</code></pre>
</li>
</ol>
<h3 id="3-frontend-integration">3. Frontend Integration</h3>
<p>Add the client library to your page:</p>
<pre class="language-html" data-language="html"><code is:raw="" class="language-html"><span class="token comment">&#x3C;!– HTML form –></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">“</span>comments-section<span class="token punctuation">“</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>h2</span><span class="token punctuation">></span></span>Comments<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>h2</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">“</span>comments<span class="token punctuation">“</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>div</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>h3</span><span class="token punctuation">></span></span>Leave a Comment<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>h3</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>form</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">“</span>comment-form<span class="token punctuation">“</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>input</span>
      <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">“</span>text<span class="token punctuation">“</span></span>
      <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">“</span>author<span class="token punctuation">“</span></span>
      <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">“</span>Your name<span class="token punctuation">“</span></span>
      <span class="token attr-name">required</span>
    <span class="token punctuation">/></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>input</span>
      <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">“</span>email<span class="token punctuation">“</span></span>
      <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">“</span>email<span class="token punctuation">“</span></span>
      <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">“</span>Your email (not shown)<span class="token punctuation">“</span></span>
      <span class="token attr-name">required</span>
    <span class="token punctuation">/></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>textarea</span>
      <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">“</span>content<span class="token punctuation">“</span></span>
      <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">“</span>Your comment (supports **bold**, *italic*, §§CODE§§26§§, [links](url))<span class="token punctuation">“</span></span>
      <span class="token attr-name">required</span>
    <span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>textarea</span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">“</span>hidden<span class="token punctuation">“</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">“</span>parentId<span class="token punctuation">“</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">“</span><span class="token punctuation">“</span></span> <span class="token punctuation">/></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">“</span>submit<span class="token punctuation">“</span></span><span class="token punctuation">></span></span>Post Comment<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>button</span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">“</span>form-message<span class="token punctuation">“</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>form</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>div</span><span class="token punctuation">></span></span>

<span class="token comment">&#x3C;!– Client library –></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">“</span>/path/to/standard.comment.js<span class="token punctuation">“</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>script</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">const</span> comments <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GitHubComments</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">apiUrl</span><span class="token operator">:</span> <span class="token string">“/api/comments”</span><span class="token punctuation">,</span>
    <span class="token literal-property property">pageId</span><span class="token operator">:</span> <span class="token string">“blog/my-post”</span><span class="token punctuation">,</span>
    <span class="token literal-property property">container</span><span class="token operator">:</span> <span class="token string">“#comments”</span><span class="token punctuation">,</span>
    <span class="token literal-property property">form</span><span class="token operator">:</span> <span class="token string">“#comment-form”</span><span class="token punctuation">,</span>
    <span class="token literal-property property">pollInterval</span><span class="token operator">:</span> <span class="token number">30,000</span><span class="token punctuation">,</span> <span class="token comment">// Check for new comments every 30s (optional)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Load and display comments</span> comments<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> comments<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Attach form handler</span> comments<span class="token punctuation">.</span><span class="token function">attachFormHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Optional: start polling for new comments</span> comments<span class="token punctuation">.</span><span class="token function">startPolling</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>script</span><span class="token punctuation">></span></span>
</code></pre>
<h3 id="4-css-styling-optional">4. CSS Styling (Optional)</h3>
<pre class="language-css" data-language="css"><code is:raw="" class="language-css"><span class="token comment">/* Comment container */</span>
<span class="token selector">.comment</span> <span class="token punctuation">{</span>
  <span class="token property">border</span><span class="token punctuation">:</span> 1px solid #e5e5e5<span class="token punctuation">;</span>
  <span class="token property">border-radius</span><span class="token punctuation">:</span> 0.5rem<span class="token punctuation">;</span>
  <span class="token property">padding</span><span class="token punctuation">:</span> 1rem<span class="token punctuation">;</span>
  <span class="token property">margin-bottom</span><span class="token punctuation">:</span> 1rem<span class="token punctuation">;</span>
  <span class="token property">background</span><span class="token punctuation">:</span> #f9f9f9<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.comment[data-level=“1”]</span> <span class="token punctuation">{</span>
  <span class="token property">margin-left</span><span class="token punctuation">:</span> 2rem<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.comment[data-level=“2”]</span> <span class="token punctuation">{</span>
  <span class="token property">margin-left</span><span class="token punctuation">:</span> 4rem<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.comment[data-pending]</span> <span class="token punctuation">{</span>
  <span class="token property">opacity</span><span class="token punctuation">:</span> 0.6<span class="token punctuation">;</span>
  <span class="token property">border-color</span><span class="token punctuation">:</span> #ffc107<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.comment[data-spam]</span> <span class="token punctuation">{</span>
  <span class="token property">border-color</span><span class="token punctuation">:</span> #dc3545<span class="token punctuation">;</span>
  <span class="token property">background</span><span class="token punctuation">:</span> #fff5f5<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* Comment header */</span>
<span class="token selector">.comment-header</span> <span class="token punctuation">{</span>
  <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span>
  <span class="token property">align-items</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>
  <span class="token property">gap</span><span class="token punctuation">:</span> 1rem<span class="token punctuation">;</span>
  <span class="token property">margin-bottom</span><span class="token punctuation">:</span> 0.5rem<span class="token punctuation">;</span>
  <span class="token property">font-size</span><span class="token punctuation">:</span> 0.9rem<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.comment-date</span> <span class="token punctuation">{</span>
  <span class="token property">color</span><span class="token punctuation">:</span> #888<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.comment-flag,.comment-pending</span> <span class="token punctuation">{</span>
  <span class="token property">font-size</span><span class="token punctuation">:</span> 0.8rem<span class="token punctuation">;</span>
  <span class="token property">padding</span><span class="token punctuation">:</span> 0.25rem 0.5rem<span class="token punctuation">;</span>
  <span class="token property">border-radius</span><span class="token punctuation">:</span> 0.25rem<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.comment-flag</span> <span class="token punctuation">{</span>
  <span class="token property">background</span><span class="token punctuation">:</span> #ffe5e5<span class="token punctuation">;</span>
  <span class="token property">color</span><span class="token punctuation">:</span> #dc3545<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.comment-pending</span> <span class="token punctuation">{</span>
  <span class="token property">background</span><span class="token punctuation">:</span> #fff3cd<span class="token punctuation">;</span>
  <span class="token property">color</span><span class="token punctuation">:</span> #856404<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* Comment content */</span>
<span class="token selector">.comment-content</span> <span class="token punctuation">{</span>
  <span class="token property">line-height</span><span class="token punctuation">:</span> 1.6<span class="token punctuation">;</span>
  <span class="token property">margin-bottom</span><span class="token punctuation">:</span> 0.5rem<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.comment-content code</span> <span class="token punctuation">{</span>
  <span class="token property">background</span><span class="token punctuation">:</span> #f4f4f4<span class="token punctuation">;</span>
  <span class="token property">padding</span><span class="token punctuation">:</span> 0.2rem 0.4rem<span class="token punctuation">;</span>
  <span class="token property">border-radius</span><span class="token punctuation">:</span> 0.25rem<span class="token punctuation">;</span>
  <span class="token property">font-family</span><span class="token punctuation">:</span> monospace<span class="token punctuation">;</span>
  <span class="token property">font-size</span><span class="token punctuation">:</span> 0.9em<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.comment-content pre</span> <span class="token punctuation">{</span>
  <span class="token property">background</span><span class="token punctuation">:</span> #f4f4f4<span class="token punctuation">;</span>
  <span class="token property">padding</span><span class="token punctuation">:</span> 1rem<span class="token punctuation">;</span>
  <span class="token property">border-radius</span><span class="token punctuation">:</span> 0.5rem<span class="token punctuation">;</span>
  <span class="token property">overflow-x</span><span class="token punctuation">:</span> auto<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.comment-content a</span> <span class="token punctuation">{</span>
  <span class="token property">color</span><span class="token punctuation">:</span> #0066cc<span class="token punctuation">;</span>
  <span class="token property">text-decoration</span><span class="token punctuation">:</span> underline<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* Actions */</span>
<span class="token selector">.comment-actions</span> <span class="token punctuation">{</span>
  <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span>
  <span class="token property">gap</span><span class="token punctuation">:</span> 0.5rem<span class="token punctuation">;</span>
  <span class="token property">font-size</span><span class="token punctuation">:</span> 0.9rem<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.comment-reply</span> <span class="token punctuation">{</span>
  <span class="token property">background</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span>
  <span class="token property">border</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span>
  <span class="token property">color</span><span class="token punctuation">:</span> #0066cc<span class="token punctuation">;</span>
  <span class="token property">cursor</span><span class="token punctuation">:</span> pointer<span class="token punctuation">;</span>
  <span class="token property">text-decoration</span><span class="token punctuation">:</span> underline<span class="token punctuation">;</span>
  <span class="token property">padding</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.comment-reply:hover</span> <span class="token punctuation">{</span>
  <span class="token property">color</span><span class="token punctuation">:</span> #0052a3<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* Form */</span>
<span class="token selector">#comment-form</span> <span class="token punctuation">{</span>
  <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span>
  <span class="token property">flex-direction</span><span class="token punctuation">:</span> column<span class="token punctuation">;</span>
  <span class="token property">gap</span><span class="token punctuation">:</span> 1rem<span class="token punctuation">;</span>
  <span class="token property">max-width</span><span class="token punctuation">:</span> 600px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">#comment-form input, #comment-form textarea</span> <span class="token punctuation">{</span>
  <span class="token property">padding</span><span class="token punctuation">:</span> 0.75rem<span class="token punctuation">;</span>
  <span class="token property">border</span><span class="token punctuation">:</span> 1px solid #e5e5e5<span class="token punctuation">;</span>
  <span class="token property">border-radius</span><span class="token punctuation">:</span> 0.5rem<span class="token punctuation">;</span>
  <span class="token property">font-family</span><span class="token punctuation">:</span> inherit<span class="token punctuation">;</span>
  <span class="token property">font-size</span><span class="token punctuation">:</span> 1rem<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">#comment-form textarea</span> <span class="token punctuation">{</span>
  <span class="token property">min-height</span><span class="token punctuation">:</span> 120px<span class="token punctuation">;</span>
  <span class="token property">resize</span><span class="token punctuation">:</span> vertical<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">#comment-form button</span> <span class="token punctuation">{</span>
  <span class="token property">padding</span><span class="token punctuation">:</span> 0.75rem 1.5rem<span class="token punctuation">;</span>
  <span class="token property">background</span><span class="token punctuation">:</span> #0066cc<span class="token punctuation">;</span>
  <span class="token property">color</span><span class="token punctuation">:</span> white<span class="token punctuation">;</span>
  <span class="token property">border</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span>
  <span class="token property">border-radius</span><span class="token punctuation">:</span> 0.5rem<span class="token punctuation">;</span>
  <span class="token property">cursor</span><span class="token punctuation">:</span> pointer<span class="token punctuation">;</span>
  <span class="token property">font-weight</span><span class="token punctuation">:</span> 500<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">#comment-form button:hover</span> <span class="token punctuation">{</span>
  <span class="token property">background</span><span class="token punctuation">:</span> #0052a3<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">#comment-form button:disabled</span> <span class="token punctuation">{</span>
  <span class="token property">background</span><span class="token punctuation">:</span> #ccc<span class="token punctuation">;</span>
  <span class="token property">cursor</span><span class="token punctuation">:</span> not-allowed<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.form-message</span> <span class="token punctuation">{</span>
  <span class="token property">padding</span><span class="token punctuation">:</span> 0.75rem<span class="token punctuation">;</span>
  <span class="token property">border-radius</span><span class="token punctuation">:</span> 0.5rem<span class="token punctuation">;</span>
  <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.form-message.success</span> <span class="token punctuation">{</span>
  <span class="token property">background</span><span class="token punctuation">:</span> #d4edda<span class="token punctuation">;</span>
  <span class="token property">color</span><span class="token punctuation">:</span> #155724<span class="token punctuation">;</span>
  <span class="token property">border</span><span class="token punctuation">:</span> 1px solid #c3e6cb<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.form-message.error</span> <span class="token punctuation">{</span>
  <span class="token property">background</span><span class="token punctuation">:</span> #f8d7da<span class="token punctuation">;</span>
  <span class="token property">color</span><span class="token punctuation">:</span> #721c24<span class="token punctuation">;</span>
  <span class="token property">border</span><span class="token punctuation">:</span> 1px solid #f5c6cb<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.comments-empty</span> <span class="token punctuation">{</span>
  <span class="token property">color</span><span class="token punctuation">:</span> #888<span class="token punctuation">;</span>
  <span class="token property">font-style</span><span class="token punctuation">:</span> italic<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="comment-file-structure">Comment File Structure</h2>
<p>Each comment is stored as a JSON file:</p>
<pre class="language-plaintext" data-language="plaintext"><code is:raw="" class="language-plaintext">data/
  comments/
    blog/
      my-post/
        1729609945000-a7x9k2m1.json
        1729609967000-b4z2k9p3.json
        1729610005000-c8m5l1q7.json
</code></pre>
<p>Each file contains:</p>
<pre class="language-json" data-language="json"><code is:raw="" class="language-json"><span class="token punctuation">{</span>
  <span class="token property">“id”</span><span class="token operator">:</span> <span class="token string">“1,729,609,945,000-a7x9k2m1”</span><span class="token punctuation">,</span>
  <span class="token property">“pageId”</span><span class="token operator">:</span> <span class="token string">“blog/my-post”</span><span class="token punctuation">,</span>
  <span class="token property">“author”</span><span class="token operator">:</span> <span class="token string">“John Doe”</span><span class="token punctuation">,</span>
  <span class="token property">“email”</span><span class="token operator">:</span> <span class="token string">“§§EMAIL§§27§§”</span><span class="token punctuation">,</span>
  <span class="token property">“content”</span><span class="token operator">:</span> <span class="token string">“Great article!”</span><span class="token punctuation">,</span>
  <span class="token property">“parentId”</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
  <span class="token property">“createdAt”</span><span class="token operator">:</span> <span class="token string">“2024-10-22T15:32:25.000Z”</span><span class="token punctuation">,</span>
  <span class="token property">“approved”</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token property">“spam”</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token property">“spamReasons”</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">“spamConfidence”</span><span class="token operator">:</span> <span class="token number">0.1</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="moderation-workflow">Moderation Workflow</h2>
<h3 id="automatic-spam-detection">Automatic Spam Detection</h3>
<p>The system automatically checks for:</p>
<ul>
<li><strong>All caps content</strong> (>50% uppercase)</li>
<li><strong>Multiple URLs</strong> (>2 in one comment)</li>
<li><strong>Spam keywords</strong> (viagra, casino, lottery, etc.)</li>
<li><strong>Repeated characters</strong> (repeated letters indicate spam)</li>
<li><strong>Short content with links</strong> (classic spam pattern)</li>
</ul>
<p>Comments exceeding spam threshold (confidence > 0.5) are:</p>
<ol>
<li>Marked as <code>spam: true</code></li>
<li>Not displayed on page</li>
<li>Email sent to moderator for review</li>
</ol>
<h3 id="moderation-review">Moderation Review</h3>
<ol>
<li>Check comments in GitHub directly at <code>data/comments/</code></li>
<li>Review flagged comments (look for <code>“spam”: true</code>)</li>
<li>Either:
<ul>
<li><strong>Approve</strong>: Change <code>“approved”: true</code> and <code>“spam”: false</code></li>
<li><strong>Delete</strong>: Remove the JSON file</li>
<li><strong>Ban IP</strong>: Add to spam filter</li>
</ul>
</li>
</ol>
<h3 id="email-notifications">Email Notifications</h3>
<p>When a comment is flagged for moderation, an email is sent to <code>MODERATION_EMAIL</code> with:</p>
<ul>
<li>Comment content</li>
<li>Author information</li>
<li>Spam detection reasons and confidence score</li>
<li>Direct link to review in GitHub</li>
</ul>
<h2 id="api-reference">API Reference</h2>
<h3 id="post-apicomments">POST /api/comments</h3>
<p>Submit a new comment.</p>
<p><strong>Request:</strong></p>
<pre class="language-json" data-language="json"><code is:raw="" class="language-json"><span class="token punctuation">{</span>
  <span class="token property">“pageId”</span><span class="token operator">:</span> <span class="token string">“blog/my-post”</span><span class="token punctuation">,</span>
  <span class="token property">“author”</span><span class="token operator">:</span> <span class="token string">“John Doe”</span><span class="token punctuation">,</span>
  <span class="token property">“email”</span><span class="token operator">:</span> <span class="token string">“§§EMAIL§§28§§”</span><span class="token punctuation">,</span>
  <span class="token property">“content”</span><span class="token operator">:</span> <span class="token string">“Great article!”</span><span class="token punctuation">,</span>
  <span class="token property">“parentId”</span><span class="token operator">:</span> <span class="token null keyword">null</span>
<span class="token punctuation">}</span>
</code></pre>
<p><strong>Response (201 Created):</strong></p>
<pre class="language-json" data-language="json"><code is:raw="" class="language-json"><span class="token punctuation">{</span>
  <span class="token property">“success”</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">“comment”</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">“id”</span><span class="token operator">:</span> <span class="token string">“1,729,609,945,000-a7x9k2m1”</span><span class="token punctuation">,</span>
    <span class="token property">“pageId”</span><span class="token operator">:</span> <span class="token string">“blog/my-post”</span><span class="token punctuation">,</span>
    <span class="token property">“author”</span><span class="token operator">:</span> <span class="token string">“John Doe”</span><span class="token punctuation">,</span>
    <span class="token property">“email”</span><span class="token operator">:</span> <span class="token string">“§§EMAIL§§29§§”</span><span class="token punctuation">,</span>
    <span class="token property">“content”</span><span class="token operator">:</span> <span class="token string">“Great article!”</span><span class="token punctuation">,</span>
    <span class="token property">“parentId”</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
    <span class="token property">“createdAt”</span><span class="token operator">:</span> <span class="token string">“2024-10-22T15:32:25.000Z”</span><span class="token punctuation">,</span>
    <span class="token property">“approved”</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">“spam”</span><span class="token operator">:</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="get-apicommentspageid">GET /api/comments?pageId=…</h3>
<p>Fetch all comments for a page.</p>
<p><strong>Response:</strong></p>
<pre class="language-json" data-language="json"><code is:raw="" class="language-json"><span class="token punctuation">{</span>
  <span class="token property">“pageId”</span><span class="token operator">:</span> <span class="token string">“blog/my-post”</span><span class="token punctuation">,</span>
  <span class="token property">“count”</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
  <span class="token property">“comments”</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">“id”</span><span class="token operator">:</span> <span class="token string">“1,729,609,945,000-a7x9k2m1”</span><span class="token punctuation">,</span>
      <span class="token property">“pageId”</span><span class="token operator">:</span> <span class="token string">“blog/my-post”</span><span class="token punctuation">,</span>
      <span class="token property">“author”</span><span class="token operator">:</span> <span class="token string">“John Doe”</span><span class="token punctuation">,</span>
      <span class="token property">“email”</span><span class="token operator">:</span> <span class="token string">“§§EMAIL§§30§§”</span><span class="token punctuation">,</span>
      <span class="token property">“content”</span><span class="token operator">:</span> <span class="token string">“Great article!”</span><span class="token punctuation">,</span>
      <span class="token property">“parentId”</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
      <span class="token property">“createdAt”</span><span class="token operator">:</span> <span class="token string">“2024-10-22T15:32:25.000Z”</span><span class="token punctuation">,</span>
      <span class="token property">“approved”</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token property">“spam”</span><span class="token operator">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="error-responses">Error Responses</h3>
<p><strong>Validation Error (400):</strong></p>
<pre class="language-json" data-language="json"><code is:raw="" class="language-json"><span class="token punctuation">{</span>
  <span class="token property">“error”</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">“message”</span><span class="token operator">:</span> <span class="token string">“valid email is required; content is required”</span><span class="token punctuation">,</span>
  <span class="token property">“status”</span><span class="token operator">:</span> <span class="token number">400</span><span class="token punctuation">,</span>
  <span class="token property">“timestamp”</span><span class="token operator">:</span> <span class="token string">“2024-10-22T15:32:25.000Z”</span>
<span class="token punctuation">}</span>
</code></pre>
<p><strong>Spam Detected (500):</strong></p>
<pre class="language-json" data-language="json"><code is:raw="" class="language-json"><span class="token punctuation">{</span>
  <span class="token property">“error”</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">“message”</span><span class="token operator">:</span> <span class="token string">“Comment flagged as spam and requires moderation”</span><span class="token punctuation">,</span>
  <span class="token property">“status”</span><span class="token operator">:</span> <span class="token number">500</span><span class="token punctuation">,</span>
  <span class="token property">“timestamp”</span><span class="token operator">:</span> <span class="token string">“2024-10-22T15:32:25.000Z”</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="advanced-usage">Advanced Usage</h2>
<h3 id="rate-limiting">Rate Limiting</h3>
<p>Add rate limiting middleware to Cloudflare:</p>
<pre class="language-javascript" data-language="javascript"><code is:raw="" class="language-javascript"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">rateLimit</span><span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> env</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ip <span class="token operator">=</span> request<span class="token punctuation">.</span>headers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">“cf-connecting-ip”</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> key <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ratelimit:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ip<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

  <span class="token comment">// KV store check (requires Cloudflare KV)</span>
  <span class="token keyword">const</span> count <span class="token operator">=</span> <span class="token keyword">await</span> env<span class="token punctuation">.</span><span class="token constant">COMMENTS_KV</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">></span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">createErrorResponse</span><span class="token punctuation">(</span><span class="token string">“Too many requests”</span><span class="token punctuation">,</span> <span class="token number">429</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">await</span> env<span class="token punctuation">.</span><span class="token constant">COMMENTS_KV</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">expirationTtl</span><span class="token operator">:</span> <span class="token number">3,600</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="custom-spam-keywords">Custom Spam Keywords</h3>
<p>Extend spam detection:</p>
<pre class="language-javascript" data-language="javascript"><code is:raw="" class="language-javascript"><span class="token keyword">const</span> customSpamKeywords <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token string">“your-custom-word”</span><span class="token punctuation">,</span>
  <span class="token string">“another-spam-term”</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// In detectSpam function:</span>
<span class="token keyword">const</span> allKeywords <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">…</span>spamKeywords<span class="token punctuation">,</span> <span class="token operator">…</span>customSpamKeywords<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="email-integration">Email Integration</h3>
<p>Send moderation emails via SendGrid:</p>
<pre class="language-javascript" data-language="javascript"><code is:raw="" class="language-javascript"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">sendModerationEmail</span><span class="token punctuation">(</span><span class="token parameter">comment<span class="token punctuation">,</span> spamDetection<span class="token punctuation">,</span> env</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">“§§URL§§31§§</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">“POST”</span><span class="token punctuation">,</span>
    <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">Authorization</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Bearer </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>env<span class="token punctuation">.</span><span class="token constant">SENDGRID_API_KEY</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      <span class="token string-property property">“Content-Type”</span><span class="token operator">:</span> <span class="token string">“application/json”</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">personalizations</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
        <span class="token literal-property property">to</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> <span class="token literal-property property">email</span><span class="token operator">:</span> env<span class="token punctuation">.</span><span class="token constant">MODERATION_EMAIL</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token literal-property property">from</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">email</span><span class="token operator">:</span> <span class="token string">“§§EMAIL§§32§§”</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">subject</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">New comment needs moderation:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>comment<span class="token punctuation">.</span>pageId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">“text/plain”</span><span class="token punctuation">,</span>
        <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token function">formatEmailBody</span><span class="token punctuation">(</span>comment<span class="token punctuation">,</span> spamDetection<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="database-storage-alternative">Database Storage Alternative</h3>
<p>Store comments in Cloudflare D1 instead of GitHub:</p>
<pre class="language-javascript" data-language="javascript"><code is:raw="" class="language-javascript"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">submitToDatabase</span><span class="token punctuation">(</span><span class="token parameter">comment<span class="token punctuation">,</span> env</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> env<span class="token punctuation">.</span><span class="token constant">DB</span><span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span>
    <span class="token string">“INSERT INTO comments (id, pageId, author, content, createdAt) VALUES (?,?,?,?,?)”</span>
  <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>comment<span class="token punctuation">.</span>id<span class="token punctuation">,</span> comment<span class="token punctuation">.</span>pageId<span class="token punctuation">,</span> comment<span class="token punctuation">.</span>author<span class="token punctuation">,</span> comment<span class="token punctuation">.</span>content<span class="token punctuation">,</span> comment<span class="token punctuation">.</span>createdAt<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="troubleshooting">Troubleshooting</h2>
<h3 id="comments-not-appearing">Comments not appearing</h3>
<ol>
<li>Check Cloudflare function logs: <code>wrangler tail –env production</code></li>
<li>Verify GitHub token has <code>repo</code> scope</li>
<li>Confirm <code>GITHUB_COMMENTS_PATH</code> exists in repository</li>
<li>Check browser console for API errors</li>
</ol>
<h3 id="github-api-errors">GitHub API errors</h3>
<p><strong>401 Unauthorized:</strong></p>
<ul>
<li>Invalid or expired GitHub token</li>
<li>Token doesn’t have <code>repo</code> scope</li>
</ul>
<p><strong>403 Forbidden:</strong></p>
<ul>
<li>Token lacks write permissions</li>
<li>Rate limited by GitHub API</li>
</ul>
<p><strong>404 Not Found:</strong></p>
<ul>
<li><code>GITHUB_OWNER</code> or <code>GITHUB_REPO</code> incorrect</li>
<li><code>GITHUB_COMMENTS_PATH</code> doesn’t exist</li>
</ul>
<h3 id="form-not-submitting">Form not submitting</h3>
<ol>
<li>Check CORS headers in response</li>
<li>Verify <code>pageId</code> is provided</li>
<li>Check email validation regex</li>
<li>Look for spam detection errors in console</li>
</ol>
<h2 id="security-considerations">Security Considerations</h2>
<p>✅ <strong>What’s Protected:</strong></p>
<ul>
<li>HTML sanitization prevents XSS attacks</li>
<li>Email validation prevents spam</li>
<li>GitHub token stored in Cloudflare secrets (never exposed)</li>
<li>CORS headers configured per-environment</li>
</ul>
<p>⚠️ <strong>What You Should Monitor:</strong></p>
<ul>
<li>Spam detection thresholds (tune for your audience)</li>
<li>Rate limiting per IP (prevent DDoS)</li>
<li>Moderation queue (review flagged comments regularly)</li>
<li>Comment content (use GitHub’s moderation tools)</li>
</ul>
<h2 id="deployment-checklist">Deployment Checklist</h2>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled> GitHub personal access token created with <code>repo</code> scope</li>
<li class="task-list-item"><input type="checkbox" disabled> <code>data/comments</code> directory exists in GitHub repo</li>
<li class="task-list-item"><input type="checkbox" disabled> Cloudflare secrets configured (<code>GITHUB_TOKEN</code>, <code>GITHUB_OWNER</code>, <code>GITHUB_REPO</code>)</li>
<li class="task-list-item"><input type="checkbox" disabled> Function deployed: <code>wrangler publish –env production</code></li>
<li class="task-list-item"><input type="checkbox" disabled> Frontend form HTML added to page</li>
<li class="task-list-item"><input type="checkbox" disabled> <code>standard.comment.js</code> included in page</li>
<li class="task-list-item"><input type="checkbox" disabled> CSS styling applied</li>
<li class="task-list-item"><input type="checkbox" disabled> Tested comment submission</li>
<li class="task-list-item"><input type="checkbox" disabled> Verified comments appear in GitHub repo</li>
<li class="task-list-item"><input type="checkbox" disabled> Moderation email recipient configured (if using)</li>
</ul>
<h2 id="see-also">See Also</h2>
<ul>
<li><a href="./comments.js" preload="" hx-boost="true">comments.js</a> – Server-side handler</li>
<li><a href="./standard.comment.js" preload="" hx-boost="true">standard.comment.js</a> – Client-side library</li>
<li><a href="./utils.js" preload="" hx-boost="true">utils.js</a> – Shared utilities</li>
<li><a href="./wrangler.toml.template" preload="" hx-boost="true">wrangler.toml.template</a> – Cloudflare config template</li>
</ul>  <article class="comments-system"> <div id="comments"></div> <button id="show-comment-form-btn" type="button" class="button" onclick="document.getElementById('comment-form-wrapper').style.display='block'; this.style.display='none';">
Write a Comment
</button> <div id="comment-form-wrapper" style="display: none;"> <form id="comment-form" method="post" action="/api/comments" novalidate> <fieldset> <legend>Leave a Comment</legend> <label for="author">Your Name <span aria-label="required">*</span></label> <input type="text" id="author" name="author" placeholder="Your name will be displayed with your comment." required maxlength="100"> <label for="email">Email Address <span aria-label="required">*</span></label> <input type="email" id="email" name="email" placeholder="Your email will not be displayed publicly." required> <label for="content">Comment <span aria-label="required">*</span></label> <textarea id="content" name="content" placeholder="Share your thoughts... Supports **bold**, *italic*, `code`, and [links](url)" required minlength="3" maxlength="10000" rows="6"></textarea> <!-- Hidden fields --> <input type="hidden" id="pageId" name="pageId" value="cloudflare_comments_COMMENTS-GUIDE"> <input type="hidden" id="parentId" name="parentId" value=""> <!-- Status indicator --> <div id="form-status" role="status" aria-live="polite"></div> <!-- Submit buttons --> <div class="form-actions"> <button type="submit" class="button">Post Comment</button>   </div> </fieldset> </form> </div> </article> <script defer>(function(){const initOptions = {"apiUrl":"/api/comments","pageId":"cloudflare_comments_COMMENTS-GUIDE","container":"#comments","form":"#comment-form","pollInterval":null};

  document.addEventListener("DOMContentLoaded", async () => {
    // Assuming GitHubComments is loaded globally or imported. 
    // Since the original used a global script, we might need to import it here or assume it's available.
    // For now, we'll assume the user includes the standard.comment.js script separately or we should import it.
    // But standard.comment.js is in dist/.
    
    if (typeof GitHubComments !== 'undefined') {
      const comments = new GitHubComments(initOptions);
      try {
        await comments.load();
        comments.render();
      } catch (error) {
        console.error("Error loading comments:", error);
        const container = document.querySelector("#comments");
        if (container) container.innerHTML = '<p class="error">Failed to load comments. Please try again later.</p>';
      }
      comments.attachFormHandler();
    }
  });
})();</script> </main> <hr> <footer class="smaller font-interface"> <p>
© 2025 Francis Fontaine ·
<a href="/">Standard Framework</a> ·
<a href="https://github.com/ZeFish/Standard/blob/main/LICENSE" class="external-link">MIT License</a> </p> </footer> </body></html>
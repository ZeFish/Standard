/**
 * Standard Framework - Fine-Art Typography Management
 *
 * A comprehensive framework implementing:
 * - Classical typography rules that CSS cannot handle
 * - Progressive enhancement with zero-configuration setup
 * - Multi-locale support with automatic detection
 * - Dynamic content observation
 * - Performance-optimized batch processing
 *
 * Based on research from:
 * - The Elements of Typographic Style (Robert Bringhurst)
 * - Ellen Lupton's typography works
 * - Classical European typography conventions
 * - Swiss typography principles
 * - Modern web accessibility standards
 *
 * Philosophy: Respect classic typography rules, but readability always wins.
 *
 * @version 2.0.0
 * @license MIT
 */
class Standard{constructor(options={}){this.options={locale:null,enableWidowPrevention:false,enableSmartQuotes:false,enablePunctuation:false,enableSpacing:false,enableFractions:false,enableNumberFormatting:false,autoProcess:false,observeDOM:false,debounceDelay:100,batchSize:50,excludeSelectors:"nav, .nav, [role='navigation']",excludeFromWidows:"h1, h2, h3, h4, h5, h6",...options};if(!this.options.locale){this.options.locale=this.detectLocale()}this.rules=this.getRulesForLocale(this.options.locale);this.observer=null;this.processingQueue=[];this.isProcessing=false;this.debounceTimer=null;this.init()}init(){if(this.options.autoProcess===false){return}if(document.readyState==="loading"){document.addEventListener("DOMContentLoaded",()=>this.process())}else{this.process()}if(this.options.observeDOM){this.observeDynamicContent()}}detectLocale(){const htmlLang=document.documentElement.lang;if(htmlLang){return htmlLang.split("-")[0].toLowerCase()}if(navigator.language){return navigator.language.split("-")[0].toLowerCase()}return"en"}getRulesForLocale(locale){const rules={en:{thinSpace:" ",nonBreakingSpace:" ",emDash:"—",enDash:"–",ellipsis:"…",leftDoubleQuote:"“",rightDoubleQuote:"”",leftSingleQuote:"‘",rightSingleQuote:"’",apostrophe:"’",numberSeparator:",",decimalSeparator:"."},fr:{thinSpace:" ",nonBreakingSpace:" ",emDash:"—",enDash:"–",ellipsis:"…",leftDoubleQuote:"«",rightDoubleQuote:"»",leftSingleQuote:"‘",rightSingleQuote:"’",apostrophe:"’",numberSeparator:" ",decimalSeparator:","},de:{thinSpace:" ",nonBreakingSpace:" ",emDash:"—",enDash:"–",ellipsis:"…",leftDoubleQuote:"„",rightDoubleQuote:"“",leftSingleQuote:"‚",rightSingleQuote:"‘",apostrophe:"’",numberSeparator:".",decimalSeparator:","},es:{thinSpace:" ",nonBreakingSpace:" ",emDash:"—",enDash:"–",ellipsis:"…",leftDoubleQuote:"«",rightDoubleQuote:"»",leftSingleQuote:"‘",rightSingleQuote:"’",apostrophe:"’",numberSeparator:".",decimalSeparator:","},it:{thinSpace:" ",nonBreakingSpace:" ",emDash:"—",enDash:"–",ellipsis:"…",leftDoubleQuote:"«",rightDoubleQuote:"»",leftSingleQuote:"‘",rightSingleQuote:"’",apostrophe:"’",numberSeparator:".",decimalSeparator:","}};return rules[locale]||rules.en}async process(selector="p, li, blockquote, h1, h2, h3, h4, h5, h6"){this.dispatchEvent("beforeProcessAll",{selector:selector});const elements=document.querySelectorAll(selector);const filteredElements=Array.from(elements).filter(element=>{if(this.options.excludeSelectors){const excludeSelectors=this.options.excludeSelectors.split(",").map(s=>s.trim());for(const excludeSelector of excludeSelectors){if(element.closest(excludeSelector)){return false}}}return this.shouldProcess(element)});await this.processBatch(filteredElements);this.dispatchEvent("afterProcessAll",{selector:selector,processedCount:filteredElements.length,totalCount:elements.length})}async processBatch(elements){const batchSize=this.options.batchSize;for(let i=0;i<elements.length;i+=batchSize){const batch=elements.slice(i,i+batchSize);batch.forEach(el=>this.processElement(el));if(i+batchSize<elements.length){await new Promise(resolve=>setTimeout(resolve,0))}}}shouldProcess(element){if(element.getAttribute("translate")==="no"){return false}const skipTags=["CODE","PRE","SCRIPT","STYLE","SAMP","KBD","VAR"];if(skipTags.includes(element.tagName)){return false}let parent=element.parentElement;while(parent){if(skipTags.includes(parent.tagName)){return false}if(parent.getAttribute("translate")==="no"){return false}parent=parent.parentElement}return true}processElement(element){if(element.hasAttribute("data-typography-processed")){return}const elementOptions=this.getElementOptions(element);this.dispatchEvent("beforeProcess",{element:element});this.storeOriginalContent(element);const elementLocale=this.getElementLocale(element);const rules=this.getRulesForLocale(elementLocale);this.processTextNodes(element,elementLocale,rules,elementOptions);element.setAttribute("data-typography-processed","true");this.dispatchEvent("afterProcess",{element:element})}getElementOptions(element){return{enableSmartQuotes:element.dataset.standardQuotes!=="false"&&this.options.enableSmartQuotes,enablePunctuation:element.dataset.standardPunctuation!=="false"&&this.options.enablePunctuation,enableWidowPrevention:element.dataset.standardWidows!=="false"&&this.options.enableWidowPrevention,enableSpacing:element.dataset.standardSpacing!=="false"&&this.options.enableSpacing,enableFractions:element.dataset.standardFractions!=="false"&&this.options.enableFractions,enableNumberFormatting:element.dataset.standardNumbers!=="false"&&this.options.enableNumberFormatting}}processTextNodes(element,elementLocale,rules,elementOptions){const walker=document.createTreeWalker(element,NodeFilter.SHOW_TEXT,null,false);const textNodes=[];let node;while(node=walker.nextNode()){if(!this.shouldProcess(node.parentElement)){continue}textNodes.push(node)}textNodes.forEach(textNode=>{let text=textNode.nodeValue;const originalText=text;if(!text||!text.trim()){return}if(elementOptions.enablePunctuation){text=this.fixPunctuation(text,rules)}if(elementOptions.enableSmartQuotes){text=this.fixQuotes(text,rules);text=this.fixApostrophes(text,rules)}if(elementOptions.enableFractions){text=this.fixFractions(text)}if(elementOptions.enableNumberFormatting){text=this.fixNumbers(text,elementLocale,rules)}if(elementOptions.enableSpacing){text=this.fixSpacing(text,elementLocale,rules)}if(text!==originalText){textNode.nodeValue=text}});if(elementOptions.enableWidowPrevention&&!this.shouldExcludeFromWidows(element)){this.preventWidowsForElement(element,elementLocale,rules)}}getElementLocale(element){if(element.dataset&&element.dataset.standardLocale){return element.dataset.standardLocale.toLowerCase()}const elementLang=element.getAttribute("lang");if(elementLang){return elementLang.split("-")[0].toLowerCase()}let parent=element.parentElement;while(parent){const parentLang=parent.getAttribute("lang");if(parentLang){return parentLang.split("-")[0].toLowerCase()}parent=parent.parentElement}return this.options.locale}fixPunctuation(text,rules=this.rules){if(text.includes(rules.emDash)&&text.includes(rules.enDash)&&text.includes(rules.ellipsis)){return text}text=text.replace(/---/g,rules.emDash);text=text.replace(/--/g,rules.emDash);text=text.replace(/\.\.\./g,rules.ellipsis);text=text.replace(/\s+-\s+/g,` ${rules.enDash} `);text=text.replace(/(\d+)-(\d+)/g,`$1${rules.enDash}$2`);return text}fixQuotes(text,rules=this.rules){if(text.includes(rules.leftDoubleQuote)||text.includes(rules.rightDoubleQuote)){return text}text=text.replace(/"([^"]*?)"/g,(match,content)=>`${rules.leftDoubleQuote}${content}${rules.rightDoubleQuote}`);text=text.replace(/'([^']*?)'/g,(match,content)=>`${rules.leftSingleQuote}${content}${rules.rightSingleQuote}`);return text}fixApostrophes(text,rules=this.rules){text=text.replace(/(\w)'(\w)/g,`$1${rules.apostrophe}$2`);text=text.replace(/\s'(\d{2}s)/g,` ${rules.apostrophe}$1`);text=text.replace(/\b'(twas|til|cause)\b/gi,`${rules.apostrophe}$1`);text=text.replace(/(\w)s'(\s|$)/g,`$1s${rules.apostrophe}$2`);return text}fixFractions(text){const fractions={"1/2":"½","1/3":"⅓","2/3":"⅔","1/4":"¼","3/4":"¾","1/5":"⅕","2/5":"⅖","3/5":"⅗","4/5":"⅘","1/6":"⅙","5/6":"⅚","1/8":"⅛","3/8":"⅜","5/8":"⅝","7/8":"⅞"};Object.entries(fractions).forEach(([ascii,unicode])=>{const regex=new RegExp(`\\b${ascii.replace("/","\\/")}\\b`,"g");text=text.replace(regex,unicode)});return text}fixNumbers(text,locale=this.options.locale,rules=this.rules){const numberRegex=/\b(\d{4,})\b/g;text=text.replace(numberRegex,match=>{if(match.length===4&&match>="1900"&&match<="2099"){return match}if(locale==="fr"){return match.replace(/(\d)(?=(\d{3})+$)/g,`$1${rules.thinSpace}`)}else if(locale==="de"||locale==="es"||locale==="it"){return match.replace(/(\d)(?=(\d{3})+$)/g,"$1.")}else{return match.replace(/(\d)(?=(\d{3})+$)/g,"$1,")}});return text}fixSpacing(text,locale=this.options.locale,rules=this.rules){if(locale==="fr"){return this.fixFrenchSpacing(text,rules)}return this.fixEnglishSpacing(text,rules)}fixFrenchSpacing(text,rules=this.rules){text=text.replace(new RegExp(`\\s*(?!${rules.thinSpace})([:;!?])`,"g"),`${rules.thinSpace}$1`);text=text.replace(new RegExp(`«(?!${rules.thinSpace})\\s*`,"g"),`«${rules.thinSpace}`);text=text.replace(new RegExp(`\\s*(?!${rules.thinSpace})»`,"g"),`${rules.thinSpace}»`);return text}fixEnglishSpacing(text,rules=this.rules){text=text.replace(/\s+/g," ");text=text.replace(/\s+([,.!?;:])/g,"$1");return text}shouldExcludeFromWidows(element){if(!this.options.excludeFromWidows)return false;const excludeSelectors=this.options.excludeFromWidows.split(",").map(s=>s.trim());return excludeSelectors.some(selector=>element.matches(selector))}preventWidowsForElement(element,locale=this.options.locale,rules=this.rules){const fullText=element.textContent;if(fullText.includes(rules.nonBreakingSpace)){return}if(fullText.trim().split(/\s+/).length<3){return}const walker=document.createTreeWalker(element,NodeFilter.SHOW_TEXT,null,false);let lastTextNode=null;let node;while(node=walker.nextNode()){if(node.nodeValue.trim().length>0){lastTextNode=node}}if(!lastTextNode)return;let text=lastTextNode.nodeValue;const nbspRegex=/\s+(\S+)\s*$/;text=text.replace(nbspRegex,`${rules.nonBreakingSpace}$1`);lastTextNode.nodeValue=text;walker.currentNode=element;while(node=walker.nextNode()){if(!this.shouldProcess(node.parentElement))continue;let text=node.nodeValue;if(!text||!text.trim())continue;if(locale==="fr"){text=this.preventFrenchOrphans(text,rules)}else if(locale==="de"){text=this.preventGermanOrphans(text,rules)}else if(locale==="es"){text=this.preventSpanishOrphans(text,rules)}else if(locale==="it"){text=this.preventItalianOrphans(text,rules)}else{text=this.preventEnglishOrphans(text,rules)}node.nodeValue=text}}preventEnglishOrphans(text,rules=this.rules){const shortWords=["a","an","at","be","by","do","go","he","if","in","is","it","me","my","no","of","on","or","so","to","up","us","we","the","and","but","for","nor","yet","was","are","has","had","can","may","will"];const pattern=`\\b(${shortWords.join("|")})\\s`;const regex=new RegExp(pattern,"gi");text=text.replace(regex,`$1${rules.nonBreakingSpace}`);text=text.replace(/\b(Mr|Mrs|Ms|Dr|Prof|St)\.\s/gi,`$1.${rules.nonBreakingSpace}`);text=text.replace(/\b(\d+)\s(am|pm)\b/gi,`$1${rules.nonBreakingSpace}$2`);text=text.replace(/\b(\d+)\s(st|nd|rd|th)\b/gi,`$1${rules.nonBreakingSpace}$2`);return text}preventFrenchOrphans(text,rules=this.rules){const shortWords=["à","a","y","un","le","la","de","du","en","ce","et","ou","où","il","on","je","tu","me","te","se","ne","si","ça","au","aux","les","des","une","son","sa","ses","ton","ta","tes","mon","ma","mes","nos","vos","par","sur","pour","dans","avec","sans","mais","donc","car","qui","que","quoi","dont","est","sont","ont","était","sera"];const pattern=`\\b(${shortWords.join("|")})\\s`;const regex=new RegExp(pattern,"gi");text=text.replace(regex,`$1${rules.nonBreakingSpace}`);text=text.replace(/\b(M|Mme|Mlle|Dr|Pr|St|Ste)\.\s/gi,`$1.${rules.nonBreakingSpace}`);text=text.replace(/\b(\d+)\s(h|min|s|kg|g|m|km|cm|mm|€|%)\b/gi,`$1${rules.nonBreakingSpace}$2`);return text}preventGermanOrphans(text,rules=this.rules){const shortWords=["an","am","im","in","um","zu","ob","da","ab","der","die","das","den","dem","des","ein","eine","einer","eines","einem","einen","und","oder","aber","denn","wenn","weil","dass","als","bis","für","mit","nach","seit","von","vor","bei","aus","über","unter","ist","sind","war","hat","wird"];const pattern=`\\b(${shortWords.join("|")})\\s`;const regex=new RegExp(pattern,"gi");text=text.replace(regex,`$1${rules.nonBreakingSpace}`);text=text.replace(/\b(Dr|Prof|Dipl|Ing|Herr|Frau)\.\s/gi,`$1.${rules.nonBreakingSpace}`);text=text.replace(/\b(\d+)\s(Uhr|kg|g|m|km|cm|mm|€|%)\b/gi,`$1${rules.nonBreakingSpace}$2`);return text}preventSpanishOrphans(text,rules=this.rules){const shortWords=["a","y","o","u","e","el","la","lo","un","en","de","al","del","por","con","sin","los","las","una","unos","unas","pero","para","como","más","muy","qué","que","quien","cual","son","está","han","hay","fue","ser"];const pattern=`\\b(${shortWords.join("|")})\\s`;const regex=new RegExp(pattern,"gi");text=text.replace(regex,`$1${rules.nonBreakingSpace}`);text=text.replace(/\b(Sr|Sra|Dr|Dra|Prof)\.\s/gi,`$1.${rules.nonBreakingSpace}`);text=text.replace(/\b(\d+)\s(h|min|s|kg|g|m|km|cm|mm|€|%)\b/gi,`$1${rules.nonBreakingSpace}$2`);return text}preventItalianOrphans(text,rules=this.rules){const shortWords=["a","e","o","è","i","il","lo","la","un","in","di","da","su","al","del","per","con","gli","una","dei","delle","nel","alla","dalla","sulla","come","più","che","chi","cui","dove","sono","hanno","stato","essere","fare"];const pattern=`\\b(${shortWords.join("|")})\\s`;const regex=new RegExp(pattern,"gi");text=text.replace(regex,`$1${rules.nonBreakingSpace}`);text=text.replace(/\b(Sig|Dott|Prof|Ing)\.\s/gi,`$1.${rules.nonBreakingSpace}`);text=text.replace(/\b(\d+)\s(h|min|s|kg|g|m|km|cm|mm|€|%)\b/gi,`$1${rules.nonBreakingSpace}$2`);return text}observeDynamicContent(){if(typeof MutationObserver==="undefined")return;this.observer=new MutationObserver(mutations=>{clearTimeout(this.debounceTimer);this.debounceTimer=setTimeout(()=>{mutations.forEach(mutation=>{mutation.addedNodes.forEach(node=>{if(node.nodeType===Node.ELEMENT_NODE){this.processNewContent(node)}})})},this.options.debounceDelay)});this.observer.observe(document.body,{childList:true,subtree:true});this.dispatchEvent("observerStarted",{})}processNewContent(element){if(element.nodeType===Node.ELEMENT_NODE){if(this.shouldProcess(element)){const selector=element.tagName.toLowerCase();if(["p","li","blockquote","h1","h2","h3","h4","h5","h6"].includes(selector)){this.processElement(element)}}const children=element.querySelectorAll("p, li, blockquote, h1, h2, h3, h4, h5, h6");children.forEach(child=>{if(this.shouldProcess(child)){this.processElement(child)}})}}dispatchEvent(eventName,detail){if(typeof CustomEvent==="undefined")return;document.dispatchEvent(new CustomEvent(`standard:${eventName}`,{detail:{...detail,timestamp:Date.now()}}))}refresh(){this.dispatchEvent("beforeRefresh",{});this.restoreAllOriginalContent();this.process();this.dispatchEvent("afterRefresh",{})}clearProcessedMarkers(){const processedElements=document.querySelectorAll("[data-typography-processed]");processedElements.forEach(element=>{element.removeAttribute("data-typography-processed")})}storeOriginalContent(element){if(!element.hasAttribute("data-original-content")){element.setAttribute("data-original-content",element.innerHTML)}}restoreOriginalContent(element){const original=element.getAttribute("data-original-content");if(original){element.innerHTML=original;element.removeAttribute("data-original-content");element.removeAttribute("data-typography-processed")}}restoreAllOriginalContent(){const processedElements=document.querySelectorAll("[data-typography-processed]");processedElements.forEach(element=>{this.restoreOriginalContent(element)})}destroy(){this.dispatchEvent("beforeDestroy",{});if(this.observer){this.observer.disconnect();this.observer=null}if(this.debounceTimer){clearTimeout(this.debounceTimer);this.debounceTimer=null}this.clearProcessedMarkers();this.dispatchEvent("afterDestroy",{})}updateOptions(newOptions){const oldOptions={...this.options};this.options={...this.options,...newOptions};if(newOptions.locale&&newOptions.locale!==oldOptions.locale){this.rules=this.getRulesForLocale(this.options.locale)}if(newOptions.observeDOM!==undefined){if(newOptions.observeDOM&&!this.observer){this.observeDynamicContent()}else if(!newOptions.observeDOM&&this.observer){this.observer.disconnect();this.observer=null}}this.dispatchEvent("optionsUpdated",{oldOptions:oldOptions,newOptions:newOptions});const typographyOptions=["enableWidowPrevention","enableSmartQuotes","enablePunctuation","enableSpacing","enableFractions","enableNumberFormatting","locale"];const shouldRefresh=typographyOptions.some(key=>newOptions[key]!==undefined&&newOptions[key]!==oldOptions[key]);if(shouldRefresh){this.refresh()}}getConfig(){return{options:{...this.options},locale:this.options.locale,rules:{...this.rules},isObserving:!!this.observer}}}if(typeof window!=="undefined"&&!window.StandardLoaded){window.StandardLoaded=true;window.Standard=Standard;window.standard=new Standard({autoProcess:true,observeDOM:true,enableWidowPrevention:true,enableSmartQuotes:true,enablePunctuation:true,enableSpacing:true,enableFractions:true,enableNumberFormatting:false});document.addEventListener("standard:afterProcessAll",e=>{})}if(typeof module!=="undefined"&&module.exports){module.exports={Standard:Standard}}if(typeof exports!=="undefined"){exports.Standard=Standard}
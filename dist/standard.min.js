/**
 * Standard Framework - Fine-Art Typography Management
 *
 * A comprehensive framework implementing:
 * - Classical typography rules that CSS cannot handle
 * - Progressive enhancement with zero-configuration setup
 * - Multi-locale support with automatic detection
 * - Dynamic content observation
 * - Performance-optimized batch processing
 *
 * Based on research from:
 * - The Elements of Typographic Style (Robert Bringhurst)
 * - Ellen Lupton's typography works
 * - Classical European typography conventions
 * - Swiss typography principles
 * - Modern web accessibility standards
 *
 * Philosophy: Respect classic typography rules, but readability always wins.
 *
 * @version 2.1.0
 * @license MIT
 */
class Standard{constructor(e={}){this.options={locale:null,enableWidowPrevention:!1,enableSmartQuotes:!1,enablePunctuation:!1,enableSpacing:!1,enableFractions:!1,enableNumberFormatting:!1,enableArrowsAndSymbols:!1,autoProcess:!1,observeDOM:!1,debounceDelay:100,batchSize:50,excludeSelectors:"nav, .nav, [role='navigation']",excludeFromWidows:"h1, h2, h3, h4, h5, h6",...e},this.options.locale||(this.options.locale=this.detectLocale()),this.rules=this.getRulesForLocale(this.options.locale),this.observer=null,this.processingQueue=[],this.isProcessing=!1,this.debounceTimer=null,this.init()}init(){!1!==this.options.autoProcess&&("loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>this.process()):this.process(),this.options.observeDOM&&this.observeDynamicContent())}detectLocale(){const e=document.documentElement.lang;return e?e.split("-")[0].toLowerCase():navigator.language?navigator.language.split("-")[0].toLowerCase():"en"}getRulesForLocale(e){const t={en:{thinSpace:" ",nonBreakingSpace:" ",emDash:"—",enDash:"–",ellipsis:"…",leftDoubleQuote:"“",rightDoubleQuote:"”",leftSingleQuote:"‘",rightSingleQuote:"’",apostrophe:"’",numberSeparator:",",decimalSeparator:".",rightArrow:"→",leftArrow:"←",upArrow:"↑",downArrow:"↓",doubleRightArrow:"⇒",doubleLeftArrow:"⇐",leftRightArrow:"↔",multiplication:"×",division:"÷",plusMinus:"±",notEqual:"≠",lessThanEqual:"≤",greaterThanEqual:"≥",approximately:"≈",copyright:"©",registered:"®",trademark:"™",degree:"°",bullet:"•",middleDot:"·"},fr:{thinSpace:" ",nonBreakingSpace:" ",emDash:"—",enDash:"–",ellipsis:"…",leftDoubleQuote:"«",rightDoubleQuote:"»",leftSingleQuote:"‘",rightSingleQuote:"’",apostrophe:"’",numberSeparator:" ",decimalSeparator:",",rightArrow:"→",leftArrow:"←",upArrow:"↑",downArrow:"↓",doubleRightArrow:"⇒",doubleLeftArrow:"⇐",leftRightArrow:"↔",multiplication:"×",division:"÷",plusMinus:"±",notEqual:"≠",lessThanEqual:"≤",greaterThanEqual:"≥",approximately:"≈",copyright:"©",registered:"®",trademark:"™",degree:"°",bullet:"•",middleDot:"·"},de:{thinSpace:" ",nonBreakingSpace:" ",emDash:"—",enDash:"–",ellipsis:"…",leftDoubleQuote:"„",rightDoubleQuote:"“",leftSingleQuote:"‚",rightSingleQuote:"‘",apostrophe:"’",numberSeparator:".",decimalSeparator:",",rightArrow:"→",leftArrow:"←",upArrow:"↑",downArrow:"↓",doubleRightArrow:"⇒",doubleLeftArrow:"⇐",leftRightArrow:"↔",multiplication:"×",division:"÷",plusMinus:"±",notEqual:"≠",lessThanEqual:"≤",greaterThanEqual:"≥",approximately:"≈",copyright:"©",registered:"®",trademark:"™",degree:"°",bullet:"•",middleDot:"·"},es:{thinSpace:" ",nonBreakingSpace:" ",emDash:"—",enDash:"–",ellipsis:"…",leftDoubleQuote:"«",rightDoubleQuote:"»",leftSingleQuote:"‘",rightSingleQuote:"’",apostrophe:"’",numberSeparator:".",decimalSeparator:",",rightArrow:"→",leftArrow:"←",upArrow:"↑",downArrow:"↓",doubleRightArrow:"⇒",doubleLeftArrow:"⇐",leftRightArrow:"↔",multiplication:"×",division:"÷",plusMinus:"±",notEqual:"≠",lessThanEqual:"≤",greaterThanEqual:"≥",approximately:"≈",copyright:"©",registered:"®",trademark:"™",degree:"°",bullet:"•",middleDot:"·"},it:{thinSpace:" ",nonBreakingSpace:" ",emDash:"—",enDash:"–",ellipsis:"…",leftDoubleQuote:"«",rightDoubleQuote:"»",leftSingleQuote:"‘",rightSingleQuote:"’",apostrophe:"’",numberSeparator:".",decimalSeparator:",",rightArrow:"→",leftArrow:"←",upArrow:"↑",downArrow:"↓",doubleRightArrow:"⇒",doubleLeftArrow:"⇐",leftRightArrow:"↔",multiplication:"×",division:"÷",plusMinus:"±",notEqual:"≠",lessThanEqual:"≤",greaterThanEqual:"≥",approximately:"≈",copyright:"©",registered:"®",trademark:"™",degree:"°",bullet:"•",middleDot:"·"}};return t[e]||t.en}async process(e="p, li, blockquote, h1, h2, h3, h4, h5, h6"){this.dispatchEvent("beforeProcessAll",{selector:e});const t=document.querySelectorAll(e),r=Array.from(t).filter(e=>{if(this.options.excludeSelectors){const t=this.options.excludeSelectors.split(",").map(e=>e.trim());for(const r of t)if(e.closest(r))return!1}return this.shouldProcess(e)});await this.processBatch(r),this.dispatchEvent("afterProcessAll",{selector:e,processedCount:r.length,totalCount:t.length})}async processBatch(e){const t=this.options.batchSize;for(let r=0;r<e.length;r+=t){e.slice(r,r+t).forEach(e=>this.processElement(e)),r+t<e.length&&await new Promise(e=>setTimeout(e,0))}}shouldProcess(e){if("no"===e.getAttribute("translate"))return!1;const t=["CODE","PRE","SCRIPT","STYLE","SAMP","KBD","VAR"];if(t.includes(e.tagName))return!1;let r=e.parentElement;for(;r;){if(t.includes(r.tagName))return!1;if("no"===r.getAttribute("translate"))return!1;r=r.parentElement}return!0}processElement(e){if(e.hasAttribute("data-typography-processed"))return;const t=this.getElementOptions(e);this.dispatchEvent("beforeProcess",{element:e});const r=this.getElementLocale(e),n=this.getRulesForLocale(r);this.processTextNodes(e,r,n,t),e.setAttribute("data-typography-processed","true"),this.dispatchEvent("afterProcess",{element:e})}getElementOptions(e){return{enableSmartQuotes:"false"!==e.dataset.standardQuotes&&this.options.enableSmartQuotes,enablePunctuation:"false"!==e.dataset.standardPunctuation&&this.options.enablePunctuation,enableWidowPrevention:"false"!==e.dataset.standardWidows&&this.options.enableWidowPrevention,enableSpacing:"false"!==e.dataset.standardSpacing&&this.options.enableSpacing,enableFractions:"false"!==e.dataset.standardFractions&&this.options.enableFractions,enableNumberFormatting:"false"!==e.dataset.standardNumbers&&this.options.enableNumberFormatting,enableArrowsAndSymbols:"false"!==e.dataset.standardArrows&&this.options.enableArrowsAndSymbols}}processTextNodes(e,t,r,n){const s=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null,!1),o=[];let a;for(;a=s.nextNode();)this.shouldProcess(a.parentElement)&&o.push(a);o.forEach(e=>{let s=e.nodeValue;const o=s;s&&s.trim()&&(n.enablePunctuation&&(s=this.fixPunctuation(s,r)),n.enableSmartQuotes&&(s=this.fixQuotes(s,r),s=this.fixApostrophes(s,r)),n.enableFractions&&(s=this.fixFractions(s)),n.enableArrowsAndSymbols&&(s=this.fixArrowsAndSymbols(s,r)),n.enableNumberFormatting&&(s=this.fixNumbers(s,t,r)),n.enableSpacing&&(s=this.fixSpacing(s,t,r)),s!==o&&(e.nodeValue=s))}),n.enableWidowPrevention&&!this.shouldExcludeFromWidows(e)&&this.preventWidowsForElement(e,t,r)}getElementLocale(e){if(e.dataset&&e.dataset.standardLocale)return e.dataset.standardLocale.toLowerCase();const t=e.getAttribute("lang");if(t)return t.split("-")[0].toLowerCase();let r=e.parentElement;for(;r;){const e=r.getAttribute("lang");if(e)return e.split("-")[0].toLowerCase();r=r.parentElement}return this.options.locale}fixPunctuation(e,t=this.rules){return e.includes(t.emDash)&&e.includes(t.enDash)&&e.includes(t.ellipsis)?e:e=(e=(e=(e=(e=e.replace(/---/g,t.emDash)).replace(/--/g,t.emDash)).replace(/\.\.\./g,t.ellipsis)).replace(/\s+-\s+/g,` ${t.enDash} `)).replace(/(\d+)-(\d+)/g,`$1${t.enDash}$2`)}fixQuotes(e,t=this.rules){return e.includes(t.leftDoubleQuote)||e.includes(t.rightDoubleQuote)?e:e=(e=e.replace(/"([^"]*?)"/g,(e,r)=>`${t.leftDoubleQuote}${r}${t.rightDoubleQuote}`)).replace(/'([^']*?)'/g,(e,r)=>`${t.leftSingleQuote}${r}${t.rightSingleQuote}`)}fixApostrophes(e,t=this.rules){return e=(e=(e=(e=e.replace(/(\w)'(\w)/g,`$1${t.apostrophe}$2`)).replace(/\s'(\d{2}s)/g,` ${t.apostrophe}$1`)).replace(/\b'(twas|til|cause)\b/gi,`${t.apostrophe}$1`)).replace(/(\\w)s'(\s|$)/g,`$1s${t.apostrophe}$2`)}fixFractions(e){return Object.entries({"1/2":"½","1/3":"⅓","2/3":"⅔","1/4":"¼","3/4":"¾","1/5":"⅕","2/5":"⅖","3/5":"⅗","4/5":"⅘","1/6":"⅙","5/6":"⅚","1/8":"⅛","3/8":"⅜","5/8":"⅝","7/8":"⅞"}).forEach(([t,r])=>{const n=new RegExp(`\\b${t.replace("/","\\/")}\\b`,"g");e=e.replace(n,r)}),e}fixArrowsAndSymbols(e,t=this.rules){return e.includes(t.rightArrow)?e:e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=e.replace(/==>/g,t.doubleRightArrow)).replace(/<==/g,t.doubleLeftArrow)).replace(/<==>/g,t.leftRightArrow)).replace(/\s+->\s+/g,` ${t.rightArrow} `)).replace(/\s+<-\s+/g,` ${t.leftArrow} `)).replace(/\s+<->\s+/g,` ${t.leftRightArrow} `)).replace(/\s+x\s+/gi,` ${t.multiplication} `)).replace(/\s+\*\s+/g,` ${t.multiplication} `)).replace(/\s+\/\s+/g,` ${t.division} `)).replace(/\+\/-/g,t.plusMinus)).replace(/!=/g,t.notEqual)).replace(/<=/g,t.lessThanEqual)).replace(/>=/g,t.greaterThanEqual)).replace(/~=/g,t.approximately)).replace(/≈=/g,t.approximately)).replace(/\(c\)/gi,t.copyright)).replace(/\(r\)/gi,t.registered)).replace(/\(tm\)/gi,t.trademark)).replace(/(\d+)\s*degrees?/gi,`$1${t.degree}`)).replace(/(\d+)\s*deg\b/gi,`$1${t.degree}`)}fixNumbers(e,t=this.options.locale,r=this.rules){return e=e.replace(/\b(\d{4,})\b/g,e=>4===e.length&&e>="1900"&&e<="2099"?e:"fr"===t?e.replace(/(\d)(?=(\d{3})+$)/g,`$1${r.thinSpace}`):"de"===t||"es"===t||"it"===t?e.replace(/(\d)(?=(\d{3})+$)/g,"$1."):e.replace(/(\d)(?=(\d{3})+$)/g,"$1,"))}fixSpacing(e,t=this.options.locale,r=this.rules){return"fr"===t?this.fixFrenchSpacing(e,r):this.fixEnglishSpacing(e,r)}fixFrenchSpacing(e,t=this.rules){return e=(e=(e=e.replace(new RegExp(`\\s*(?!${t.thinSpace})([:;!?])`,"g"),`${t.thinSpace}$1`)).replace(new RegExp(`«(?!${t.thinSpace})\\s*`,"g"),`«${t.thinSpace}`)).replace(new RegExp(`\\s*(?!${t.thinSpace})»`,"g"),`${t.thinSpace}»`)}fixEnglishSpacing(e,t=this.rules){return e=(e=e.replace(/\s+/g," ")).replace(/\s+([,.!?;:])/g,"$1")}shouldExcludeFromWidows(e){if(!this.options.excludeFromWidows)return!1;return this.options.excludeFromWidows.split(",").map(e=>e.trim()).some(t=>e.matches(t))}preventWidowsForElement(e,t=this.options.locale,r=this.rules){const n=e.textContent;if(n.includes(r.nonBreakingSpace))return;if(n.trim().split(/\s+/).length<3)return;const s=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null,!1);let o,a=null;for(;o=s.nextNode();)o.nodeValue.trim().length>0&&(a=o);if(!a)return;let i=a.nodeValue;for(i=i.replace(/\s+(\S+)\s*$/,`${r.nonBreakingSpace}$1`),a.nodeValue=i,s.currentNode=e;o=s.nextNode();){if(!this.shouldProcess(o.parentElement))continue;let e=o.nodeValue;e&&e.trim()&&(e="fr"===t?this.preventFrenchOrphans(e,r):"de"===t?this.preventGermanOrphans(e,r):"es"===t?this.preventSpanishOrphans(e,r):"it"===t?this.preventItalianOrphans(e,r):this.preventEnglishOrphans(e,r),o.nodeValue=e)}}preventEnglishOrphans(e,t=this.rules){const r=`\\b(${["a","an","at","be","by","do","go","he","if","in","is","it","me","my","no","of","on","or","so","to","up","us","we","the","and","but","for","nor","yet","was","are","has","had","can","may","will"].join("|")})\\b\\s`,n=new RegExp(r,"gi");return e=(e=(e=(e=e.replace(n,`$1${t.nonBreakingSpace}`)).replace(/\b(Mr|Mrs|Ms|Dr|Prof|St)\.\s/gi,`$1.${t.nonBreakingSpace}`)).replace(/\b(\d+)\s(am|pm)\b/gi,`$1${t.nonBreakingSpace}$2`)).replace(/\b(\d+)\s(st|nd|rd|th)\b/gi,`$1${t.nonBreakingSpace}$2`)}preventFrenchOrphans(e,t=this.rules){const r=`\\b(${["à","a","y","un","le","la","de","du","en","ce","et","ou","où","il","on","je","tu","me","te","se","ne","si","ça","au","aux","les","des","une","son","sa","ses","ton","ta","tes","mon","ma","mes","nos","vos","par","sur","pour","dans","avec","sans","mais","donc","car","qui","que","quoi","dont","est","sont","ont","était","sera"].join("|")})\\b\\s`,n=new RegExp(r,"gi");return e=(e=(e=e.replace(n,`$1${t.nonBreakingSpace}`)).replace(/\b(M|Mme|Mlle|Dr|Pr|St|Ste)\.\s/gi,`$1.${t.nonBreakingSpace}`)).replace(/\b(\d+)\s(h|min|s|kg|g|m|km|cm|mm|€|%)\b/gi,`$1${t.nonBreakingSpace}$2`)}preventGermanOrphans(e,t=this.rules){const r=`\\b(${["an","am","im","in","um","zu","ob","da","ab","der","die","das","den","dem","des","ein","eine","einer","eines","einem","einen","und","oder","aber","denn","wenn","weil","dass","als","bis","für","mit","nach","seit","von","vor","bei","aus","über","unter","ist","sind","war","hat","wird"].join("|")})\\b\\s`,n=new RegExp(r,"gi");return e=(e=(e=e.replace(n,`$1${t.nonBreakingSpace}`)).replace(/\b(Dr|Prof|Dipl|Ing|Herr|Frau)\.\s/gi,`$1.${t.nonBreakingSpace}`)).replace(/\b(\d+)\s(Uhr|kg|g|m|km|cm|mm|€|%)\b/gi,`$1${t.nonBreakingSpace}$2`)}preventSpanishOrphans(e,t=this.rules){const r=`\\b(${["a","y","o","u","e","el","la","lo","un","en","de","al","del","por","con","sin","los","las","una","unos","unas","pero","para","como","más","muy","qué","que","quien","cual","son","está","han","hay","fue","ser"].join("|")})\\b\\s`,n=new RegExp(r,"gi");return e=(e=(e=e.replace(n,`$1${t.nonBreakingSpace}`)).replace(/\b(Sr|Sra|Dr|Dra|Prof)\.\s/gi,`$1.${t.nonBreakingSpace}`)).replace(/\b(\d+)\s(h|min|s|kg|g|m|km|cm|mm|€|%)\b/gi,`$1${t.nonBreakingSpace}$2`)}preventItalianOrphans(e,t=this.rules){const r=`\\b(${["a","e","o","è","i","il","lo","la","un","in","di","da","su","al","del","per","con","gli","una","dei","delle","nel","alla","dalla","sulla","come","più","che","chi","cui","dove","sono","hanno","stato","essere","fare"].join("|")})\\b\\s`,n=new RegExp(r,"gi");return e=(e=(e=e.replace(n,`$1${t.nonBreakingSpace}`)).replace(/\b(Sig|Dott|Prof|Ing)\.\s/gi,`$1.${t.nonBreakingSpace}`)).replace(/\b(\d+)\s(h|min|s|kg|g|m|km|cm|mm|€|%)\b/gi,`$1${t.nonBreakingSpace}$2`)}observeDynamicContent(){"undefined"!=typeof MutationObserver&&(this.observer=new MutationObserver(e=>{clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(()=>{e.forEach(e=>{e.addedNodes.forEach(e=>{e.nodeType===Node.ELEMENT_NODE&&this.processNewContent(e)})})},this.options.debounceDelay)}),this.observer.observe(document.body,{childList:!0,subtree:!0}),this.dispatchEvent("observerStarted",{}))}processNewContent(e){if(e.nodeType===Node.ELEMENT_NODE){if(this.shouldProcess(e)){const t=e.tagName.toLowerCase();["p","li","blockquote","h1","h2","h3","h4","h5","h6"].includes(t)&&this.processElement(e)}e.querySelectorAll("p, li, blockquote, h1, h2, h3, h4, h5, h6").forEach(e=>{this.shouldProcess(e)&&this.processElement(e)})}}dispatchEvent(e,t){"undefined"!=typeof CustomEvent&&document.dispatchEvent(new CustomEvent(`standard:${e}`,{detail:{...t,timestamp:Date.now()}}))}refresh(){this.dispatchEvent("beforeRefresh",{}),this.clearProcessedMarkers(),this.process(),this.dispatchEvent("afterRefresh",{})}clearProcessedMarkers(){document.querySelectorAll("[data-typography-processed]").forEach(e=>{e.removeAttribute("data-typography-processed")})}destroy(){this.dispatchEvent("beforeDestroy",{}),this.observer&&(this.observer.disconnect(),this.observer=null),this.debounceTimer&&(clearTimeout(this.debounceTimer),this.debounceTimer=null),this.clearProcessedMarkers(),this.dispatchEvent("afterDestroy",{})}updateOptions(e){const t={...this.options};this.options={...this.options,...e},e.locale&&e.locale!==t.locale&&(this.rules=this.getRulesForLocale(this.options.locale)),void 0!==e.observeDOM&&(e.observeDOM&&!this.observer?this.observeDynamicContent():!e.observeDOM&&this.observer&&(this.observer.disconnect(),this.observer=null)),this.dispatchEvent("optionsUpdated",{oldOptions:t,newOptions:e});["enableWidowPrevention","enableSmartQuotes","enablePunctuation","enableSpacing","enableFractions","enableNumberFormatting","enableArrowsAndSymbols","locale"].some(r=>void 0!==e[r]&&e[r]!==t[r])&&this.refresh()}getConfig(){return{options:{...this.options},locale:this.options.locale,rules:{...this.rules},isObserving:!!this.observer}}toggleBaselineGrid(e=!0){document.body.setAttribute("data-baseline-debug",e),document.documentElement.style.setProperty("--baseline-debug",e?"1":"0")}measureBaselineOffset(e="system-ui",t=16){const r=document.createElement("div");r.style.cssText=`\n      position: absolute;\n      font-family: ${e};\n      font-size: ${t}px;\n      line-height: 1;\n      visibility: hidden;\n    `,r.textContent="Hxg",document.body.appendChild(r);r.getBoundingClientRect();const n=(parseFloat(getComputedStyle(r).lineHeight)-t)/2;return document.body.removeChild(r),console.log(`Baseline offset for ${e}: ${n}px (${n/t}em)`),n/t}}"undefined"==typeof window||window.StandardLoaded||(window.StandardLoaded=!0,window.Standard=Standard,window.standard=new Standard({autoProcess:!0,observeDOM:!0,enableWidowPrevention:!0,enableSmartQuotes:!0,enablePunctuation:!0,enableSpacing:!0,enableFractions:!0,enableArrowsAndSymbols:!0,enableNumberFormatting:!1}),document.addEventListener("standard:afterProcessAll",e=>{})),"undefined"!=typeof module&&module.exports&&(module.exports={Standard:Standard}),"undefined"!=typeof exports&&(exports.Standard=Standard);
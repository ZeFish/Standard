/**
 * Standard Framework - Fine-Art Typography Management
 *
 * A comprehensive framework implementing:
 * - Classical typography rules that CSS cannot handle
 * - Progressive enhancement with zero-configuration setup
 * - Multi-locale support with automatic detection
 * - Dynamic content observation
 * - Performance-optimized batch processing
 * - Image zoom with keyboard navigation
 *
 * Based on research from:
 * - The Elements of Typographic Style (Robert Bringhurst)
 * - Ellen Lupton's typography works
 * - Classical European typography conventions
 * - Swiss typography principles
 * - Modern web accessibility standards
 *
 * Philosophy: Respect classic typography rules, but readability always wins.
 *
 * @version Standard Framework v0.11.25
 * @license MIT
 */
class Standard{constructor(e={}){this.options={locale:null,enableWidowPrevention:!1,enableSmartQuotes:!1,enablePunctuation:!1,enableSpacing:!1,enableFractions:!1,enableNumberFormatting:!1,enableArrowsAndSymbols:!1,autoProcess:!1,observeDOM:!1,debounceDelay:100,batchSize:50,excludeSelectors:"nav, .nav, [role='navigation']",excludeFromWidows:"h1, h2, h3, h4, h5, h6",includeClass:"standard-typography",...e},this.options.locale||(this.options.locale=this.detectLocale()),this.globalSymbols={rightArrow:"→",leftArrow:"←",upArrow:"↑",downArrow:"↓",doubleRightArrow:"⇒",doubleLeftArrow:"⇐",leftRightArrow:"↔",multiplication:"×",plusMinus:"±",notEqual:"≠",lessThanEqual:"≤",greaterThanEqual:"≥",approximately:"≈",copyright:"©",registered:"®",trademark:"™",degree:"°",bullet:"•",middleDot:"·"},this.rules=this.getRulesForLocale(this.options.locale),this.observer=null,this.processingQueue=[],this.isProcessing=!1,this.debounceTimer=null,this.init()}init(){!1!==this.options.autoProcess&&("loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>this.process()):this.process(),this.options.observeDOM&&this.observeDynamicContent())}detectLocale(){const e=document.documentElement.lang;return e?e.split("-")[0].toLowerCase():navigator.language?navigator.language.split("-")[0].toLowerCase():"en"}getRulesForLocale(e){const t={en:{thinSpace:" ",nonBreakingSpace:" ",emDash:"—",enDash:"–",ellipsis:"…",leftDoubleQuote:"“",rightDoubleQuote:"”",leftSingleQuote:"‘",rightSingleQuote:"’",apostrophe:"’",numberSeparator:",",decimalSeparator:"."},fr:{thinSpace:" ",nonBreakingSpace:" ",emDash:"—",enDash:"–",ellipsis:"…",leftDoubleQuote:"«",rightDoubleQuote:"»",leftSingleQuote:"‘",rightSingleQuote:"’",apostrophe:"’",numberSeparator:" ",decimalSeparator:","},de:{thinSpace:" ",nonBreakingSpace:" ",emDash:"—",enDash:"–",ellipsis:"…",leftDoubleQuote:"„",rightDoubleQuote:"“",leftSingleQuote:"‚",rightSingleQuote:"‘",apostrophe:"’",numberSeparator:".",decimalSeparator:","},es:{thinSpace:" ",nonBreakingSpace:" ",emDash:"—",enDash:"–",ellipsis:"…",leftDoubleQuote:"«",rightDoubleQuote:"»",leftSingleQuote:"‘",rightSingleQuote:"’",apostrophe:"’",numberSeparator:".",decimalSeparator:","},it:{thinSpace:" ",nonBreakingSpace:" ",emDash:"—",enDash:"–",ellipsis:"…",leftDoubleQuote:"«",rightDoubleQuote:"»",leftSingleQuote:"‘",rightSingleQuote:"’",apostrophe:"’",numberSeparator:".",decimalSeparator:","}};return t[e]||t.en}async process(e="p, li, blockquote, h1, h2, h3, h4, h5, h6"){this.dispatchEvent("beforeProcessAll",{selector:e});const t=e+(this.options.includeClass?`, .${this.options.includeClass}`:""),o=document.querySelectorAll(t),n=Array.from(o).filter(e=>{if(this.options.excludeSelectors){const t=this.options.excludeSelectors.split(",").map(e=>e.trim());for(const o of t)if(e.closest(o))return!1}return this.shouldProcess(e)});await this.processBatch(n),this.dispatchEvent("afterProcessAll",{selector:e,processedCount:n.length,totalCount:o.length})}async processBatch(e){const t=this.options.batchSize;for(let o=0;o<e.length;o+=t){e.slice(o,o+t).forEach(e=>this.processElement(e)),o+t<e.length&&await new Promise(e=>setTimeout(e,0))}}shouldProcess(e){if("no"===e.getAttribute("translate"))return!1;const t=["CODE","PRE","SCRIPT","STYLE","SAMP","KBD","VAR"];if(t.includes(e.tagName))return!1;let o=e.parentElement;for(;o;){if(t.includes(o.tagName))return!1;if("no"===o.getAttribute("translate"))return!1;o=o.parentElement}return!0}processElement(e){if(e.hasAttribute("data-typography-processed"))return;const t=this.getElementOptions(e);this.dispatchEvent("beforeProcess",{element:e});const o=this.getElementLocale(e),n=this.getRulesForLocale(o);this.processTextNodes(e,o,n,t),e.setAttribute("data-typography-processed","true"),this.dispatchEvent("afterProcess",{element:e})}getElementOptions(e){return{enableSmartQuotes:"false"!==e.dataset.standardQuotes&&this.options.enableSmartQuotes,enablePunctuation:"false"!==e.dataset.standardPunctuation&&this.options.enablePunctuation,enableWidowPrevention:"false"!==e.dataset.standardWidows&&this.options.enableWidowPrevention,enableSpacing:"false"!==e.dataset.standardSpacing&&this.options.enableSpacing,enableFractions:"false"!==e.dataset.standardFractions&&this.options.enableFractions,enableNumberFormatting:"false"!==e.dataset.standardNumbers&&this.options.enableNumberFormatting,enableArrowsAndSymbols:"false"!==e.dataset.standardArrows&&this.options.enableArrowsAndSymbols}}processTextNodes(e,t,o,n){const s=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null,!1),a=[];let i;for(;i=s.nextNode();)this.shouldProcess(i.parentElement)&&a.push(i);a.forEach(e=>{let s=e.nodeValue;const a=s;s&&s.trim()&&(n.enablePunctuation&&(s=this.fixPunctuation(s,o)),n.enableSmartQuotes&&(s=this.fixQuotes(s,o),s=this.fixApostrophes(s,o)),n.enableFractions&&(s=this.fixFractions(s)),n.enableArrowsAndSymbols&&(s=this.fixArrowsAndSymbols(s,o)),n.enableNumberFormatting&&(s=this.fixNumbers(s,t,o)),n.enableSpacing&&(s=this.fixSpacing(s,t,o)),s!==a&&(e.nodeValue=s))}),n.enableWidowPrevention&&!this.shouldExcludeFromWidows(e)&&this.preventWidowsForElement(e,t,o)}getElementLocale(e){if(e.dataset&&e.dataset.standardLocale)return e.dataset.standardLocale.toLowerCase();const t=e.getAttribute("lang");if(t)return t.split("-")[0].toLowerCase();let o=e.parentElement;for(;o;){const e=o.getAttribute("lang");if(e)return e.split("-")[0].toLowerCase();o=o.parentElement}return this.options.locale}fixPunctuation(e,t=this.rules){return e.includes(t.emDash)&&e.includes(t.enDash)&&e.includes(t.ellipsis)?e:e=(e=(e=(e=(e=e.replace(/---/g,t.emDash)).replace(/--/g,t.emDash)).replace(/\.\.\./g,t.ellipsis)).replace(/\s+-\s+/g,` ${t.enDash} `)).replace(/(\d+)-(\d+)/g,`$1${t.enDash}$2`)}fixQuotes(e,t=this.rules){return e.includes(t.leftDoubleQuote)||e.includes(t.rightDoubleQuote)?e:e=(e=e.replace(/"([^"]*?)"/g,(e,o)=>`${t.leftDoubleQuote}${o}${t.rightDoubleQuote}`)).replace(/'([^']*?)'/g,(e,o)=>`${t.leftSingleQuote}${o}${t.rightSingleQuote}`)}fixApostrophes(e,t=this.rules){return e=(e=(e=(e=e.replace(/(\w)'(\w)/g,`$1${t.apostrophe}$2`)).replace(/\s'(\d{2}s)/g,` ${t.apostrophe}$1`)).replace(/\b'(twas|til|cause)\b/gi,`${t.apostrophe}$1`)).replace(/(\w)s'(\s|$)/g,`$1s${t.apostrophe}$2`)}fixFractions(e){return Object.entries({"1/2":"½","1/3":"⅓","2/3":"⅔","1/4":"¼","3/4":"¾","1/5":"⅕","2/5":"⅖","3/5":"⅗","4/5":"⅘","1/6":"⅙","5/6":"⅚","1/8":"⅛","3/8":"⅜","5/8":"⅝","7/8":"⅞"}).forEach(([t,o])=>{const n=new RegExp(`\\b${t.replace("/","\\/")}\\b`,"g");e=e.replace(n,o)}),e}fixArrowsAndSymbols(e,t=this.rules){const o=this.globalSymbols;return e.includes(o.rightArrow)?e:e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=e.replace(/==>/g,o.doubleRightArrow)).replace(/<==/g,o.doubleLeftArrow)).replace(/<==/g,o.leftRightArrow)).replace(/->/g,o.rightArrow)).replace(/<->/g,o.leftRightArrow)).replace(/<-/g,o.leftArrow)).replace(/\s+x\s+/gi,` ${o.multiplication} `)).replace(/\s+\*\s+/g,` ${o.multiplication} `)).replace(/\+\/-/g,o.plusMinus)).replace(/!=/g,o.notEqual)).replace(/<=/g,o.lessThanEqual)).replace(/>=/g,o.greaterThanEqual)).replace(/~=/g,o.approximately)).replace(/≈=/g,o.approximately)).replace(/\(c\)/gi,o.copyright)).replace(/\(r\)/gi,o.registered)).replace(/\(tm\)/gi,o.trademark)).replace(/(\d+)\s*degrees?/gi,`$1${o.degree}`)).replace(/(\d+)\s*deg\b/gi,`$1${o.degree}`)}fixNumbers(e,t=this.options.locale,o=this.rules){return e=e.replace(/\b(\d{4,})\b/g,e=>4===e.length&&e>="1900"&&e<="2099"?e:"fr"===t?e.replace(/(\d)(?=(\d{3})+$)/g,`$1${o.thinSpace}`):"de"===t||"es"===t||"it"===t?e.replace(/(\d)(?=(\d{3})+$)/g,"$1."):e.replace(/(\d)(?=(\d{3})+$)/g,"$1,"))}fixSpacing(e,t=this.options.locale,o=this.rules){return"fr"===t?this.fixFrenchSpacing(e,o):this.fixEnglishSpacing(e,o)}fixFrenchSpacing(e,t=this.rules){return e=(e=(e=e.replace(new RegExp(`\\s*(?!${t.thinSpace})([:;!?])`,"g"),`${t.thinSpace}$1`)).replace(new RegExp(`«(?!${t.thinSpace})\\s*`,"g"),`«${t.thinSpace}`)).replace(new RegExp(`\\s*(?!${t.thinSpace})»`,"g"),`${t.thinSpace}»`)}fixEnglishSpacing(e,t=this.rules){return e=(e=e.replace(/\s+/g," ")).replace(/\s+([,.!?;:])/g,"$1")}shouldExcludeFromWidows(e){if(!this.options.excludeFromWidows)return!1;return this.options.excludeFromWidows.split(",").map(e=>e.trim()).some(t=>e.matches(t))}preventWidowsForElement(e,t=this.options.locale,o=this.rules){const n=e.textContent;if(n.includes(o.nonBreakingSpace))return;if(n.trim().split(/\s+/).length<3)return;if(e.querySelector("br"))return;const s=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null,!1);let a,i=null;for(;a=s.nextNode();)a.nodeValue.trim().length>0&&(i=a);if(!i)return;let r=i.nodeValue;for(r=r.replace(/\s+(\S+)\s*$/,`${o.nonBreakingSpace}$1`),i.nodeValue=r,s.currentNode=e;a=s.nextNode();){if(!this.shouldProcess(a.parentElement))continue;let e=a.nodeValue;e&&e.trim()&&(e="fr"===t?this.preventFrenchOrphans(e,o):"de"===t?this.preventGermanOrphans(e,o):"es"===t?this.preventSpanishOrphans(e,o):"it"===t?this.preventItalianOrphans(e,o):this.preventEnglishOrphans(e,o),a.nodeValue=e)}}preventEnglishOrphans(e,t=this.rules){const o=`\\b(${["a","an","at","be","by","do","go","he","if","in","is","it","me","my","no","of","on","or","so","to","up","us","we","the","and","but","for","nor","yet","was","are","has","had","can","may","will"].join("|")})\\b\\s`,n=new RegExp(o,"gi");return e=(e=(e=(e=e.replace(n,`$1${t.nonBreakingSpace}`)).replace(/\b(Mr|Mrs|Ms|Dr|Prof|St)\.\s/gi,`$1.${t.nonBreakingSpace}`)).replace(/\b(\d+)\s(am|pm)\b/gi,`$1${t.nonBreakingSpace}$2`)).replace(/\b(\d+)\s(st|nd|rd|th)\b/gi,`$1${t.nonBreakingSpace}$2`)}preventFrenchOrphans(e,t=this.rules){const o=`\\b(${["à","a","y","un","le","la","de","du","en","ce","et","ou","où","il","on","je","tu","me","te","se","ne","si","ça","au","aux","les","des","une","son","sa","ses","ton","ta","tes","mon","ma","mes","nos","vos","par","sur","pour","dans","avec","sans","mais","donc","car","qui","que","quoi","dont","est","sont","ont","était","sera"].join("|")})\\b\\s`,n=new RegExp(o,"gi");return e=(e=(e=e.replace(n,`$1${t.nonBreakingSpace}`)).replace(/\b(M|Mme|Mlle|Dr|Pr|St|Ste)\.\s/gi,`$1.${t.nonBreakingSpace}`)).replace(/\b(\d+)\s(h|min|s|kg|g|m|km|cm|mm|€|%)\b/gi,`$1${t.nonBreakingSpace}$2`)}preventGermanOrphans(e,t=this.rules){const o=`\\b(${["an","am","im","in","um","zu","ob","da","ab","der","die","das","den","dem","des","ein","eine","einer","eines","einem","einen","und","oder","aber","denn","wenn","weil","dass","als","bis","für","mit","nach","seit","von","vor","bei","aus","über","unter","ist","sind","war","hat","wird"].join("|")})\\b\\s`,n=new RegExp(o,"gi");return e=(e=(e=e.replace(n,`$1${t.nonBreakingSpace}`)).replace(/\b(Dr|Prof|Dipl|Ing|Herr|Frau)\.\s/gi,`$1.${t.nonBreakingSpace}`)).replace(/\b(\d+)\s(Uhr|kg|g|m|km|cm|mm|€|%)\b/gi,`$1${t.nonBreakingSpace}$2`)}preventSpanishOrphans(e,t=this.rules){const o=`\\b(${["a","y","o","u","e","el","la","lo","un","en","de","al","del","por","con","sin","los","las","una","unos","unas","pero","para","como","más","muy","qué","que","quien","cual","son","está","han","hay","fue","ser"].join("|")})\\b\\s`,n=new RegExp(o,"gi");return e=(e=(e=e.replace(n,`$1${t.nonBreakingSpace}`)).replace(/\b(Sr|Sra|Dr|Dra|Prof)\.\s/gi,`$1.${t.nonBreakingSpace}`)).replace(/\b(\d+)\s(h|min|s|kg|g|m|km|cm|mm|€|%)\b/gi,`$1${t.nonBreakingSpace}$2`)}preventItalianOrphans(e,t=this.rules){const o=`\\b(${["a","e","o","è","i","il","lo","la","un","in","di","da","su","al","del","per","con","gli","una","dei","delle","nel","alla","dalla","sulla","come","più","che","chi","cui","dove","sono","hanno","stato","essere","fare"].join("|")})\\b\\s`,n=new RegExp(o,"gi");return e=(e=(e=e.replace(n,`$1${t.nonBreakingSpace}`)).replace(/\b(Sig|Dott|Prof|Ing)\.\s/gi,`$1.${t.nonBreakingSpace}`)).replace(/\b(\d+)\s(h|min|s|kg|g|m|km|cm|mm|€|%)\b/gi,`$1${t.nonBreakingSpace}$2`)}observeDynamicContent(){"undefined"!=typeof MutationObserver&&(this.observer=new MutationObserver(e=>{clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(()=>{e.forEach(e=>{e.addedNodes.forEach(e=>{e.nodeType===Node.ELEMENT_NODE&&this.processNewContent(e)})})},this.options.debounceDelay)}),this.observer.observe(document.body,{childList:!0,subtree:!0}),this.dispatchEvent("observerStarted",{}))}processNewContent(e){if(e.nodeType===Node.ELEMENT_NODE){if(this.shouldProcess(e)){const t=e.tagName.toLowerCase();(this.options.includeClass&&e.classList.contains(this.options.includeClass)||["p","li","blockquote","h1","h2","h3","h4","h5","h6"].includes(t))&&this.processElement(e)}const t=this.options.includeClass?`, .${this.options.includeClass}`:"";e.querySelectorAll(`p, li, blockquote, h1, h2, h3, h4, h5, h6${t}`).forEach(e=>{this.shouldProcess(e)&&this.processElement(e)})}}dispatchEvent(e,t){"undefined"!=typeof CustomEvent&&document.dispatchEvent(new CustomEvent(`standard:${e}`,{detail:{...t,timestamp:Date.now()}}))}refresh(){this.dispatchEvent("beforeRefresh",{}),this.clearProcessedMarkers(),this.process(),this.dispatchEvent("afterRefresh",{})}clearProcessedMarkers(){document.querySelectorAll("[data-typography-processed]").forEach(e=>{e.removeAttribute("data-typography-processed")})}destroy(){this.dispatchEvent("beforeDestroy",{}),this.observer&&(this.observer.disconnect(),this.observer=null),this.debounceTimer&&(clearTimeout(this.debounceTimer),this.debounceTimer=null),this.clearProcessedMarkers(),this.dispatchEvent("afterDestroy",{})}updateOptions(e){const t={...this.options};this.options={...this.options,...e},e.locale&&e.locale!==t.locale&&(this.rules=this.getRulesForLocale(this.options.locale)),void 0!==e.observeDOM&&(e.observeDOM&&!this.observer?this.observeDynamicContent():!e.observeDOM&&this.observer&&(this.observer.disconnect(),this.observer=null)),this.dispatchEvent("optionsUpdated",{oldOptions:t,newOptions:e});["enableWidowPrevention","enableSmartQuotes","enablePunctuation","enableSpacing","enableFractions","enableNumberFormatting","enableArrowsAndSymbols","locale"].some(o=>void 0!==e[o]&&e[o]!==t[o])&&this.refresh()}getConfig(){return{options:{...this.options},locale:this.options.locale,rules:{...this.rules},isObserving:!!this.observer}}toggleBaselineGrid(e=!0){document.body.setAttribute("data-baseline-debug",e),document.documentElement.style.setProperty("--baseline-debug",e?"1":"0")}measureBaselineOffset(e="system-ui",t=16){const o=document.createElement("div");o.style.cssText=`\n      position: absolute;\n      font-family: ${e};\n      font-size: ${t}px;\n      line-height: 1;\n      visibility: hidden;\n    `,o.textContent="Hxg",document.body.appendChild(o);o.getBoundingClientRect();const n=(parseFloat(getComputedStyle(o).lineHeight)-t)/2;return document.body.removeChild(o),console.log(`Baseline offset for ${e}: ${n}px (${n/t}em)`),n/t}initImageZoom(){this.imageZoom={currentZoomedImage:null,images:[],zoomedClass:"zoomed",selector:"html:not(.no-rhythm) img, .prose img, .rhythm img"},this.disableImageActiveStyles(),this.bindImageZoomClicks(),this.bindImageZoomKeyboard(),this.dispatchEvent("imageZoomInitialized",{})}disableImageActiveStyles(){const e="standard-image-zoom-override";if(document.getElementById(e))return;const t=document.createElement("style");t.id=e,t.textContent="\n        /* Standard.js - Disable :active pseudo-class conflicts */\n        .prose img:active,\n        .rhythm img:active,\n        html:not(.no-rhythm) img:active {\n          /* Reset :active styles - JS handles zoom now */\n          cursor: zoom-in !important;\n          display: inline !important;\n          z-index: auto !important;\n          position: static !important;\n          max-height: none !important;\n          max-width: 100% !important;\n          object-fit: initial !important;\n          margin: 0 !important;\n          padding: 0 !important;\n          top: auto !important;\n          left: auto !important;\n          transform: none !important;\n          user-select: auto !important;\n        }\n\n        /* Remove :active backdrop overlay */\n        html:not(.no-rhythm) :has(img:active)::before,\n        .prose :has(img:active)::before,\n        .rhythm :has(img:active)::before {\n          display: none !important;\n        }\n      ",document.head.appendChild(t),this.dispatchEvent("imageZoomStylesInjected",{styleId:e})}refreshZoomableImages(){this.imageZoom.images=Array.from(document.querySelectorAll(this.imageZoom.selector))}bindImageZoomClicks(){document.addEventListener("click",e=>{const t=e.target.closest(this.imageZoom.selector);t?(e.preventDefault(),e.stopPropagation(),this.toggleImageZoom(t)):this.imageZoom.currentZoomedImage&&this.closeImageZoom()})}bindImageZoomKeyboard(){document.addEventListener("keydown",e=>{if(this.imageZoom.currentZoomedImage)switch(e.key){case"Escape":e.preventDefault(),this.closeImageZoom();break;case"ArrowLeft":e.preventDefault(),this.navigateZoomedImage(-1);break;case"ArrowRight":e.preventDefault(),this.navigateZoomedImage(1)}})}toggleImageZoom(e){this.imageZoom.currentZoomedImage===e?this.closeImageZoom():this.openImageZoom(e)}openImageZoom(e){this.imageZoom.currentZoomedImage&&this.closeImageZoom(),e.classList.add(this.imageZoom.zoomedClass),this.imageZoom.currentZoomedImage=e,document.body.style.overflow="hidden",this.dispatchEvent("imageZoomOpen",{image:e})}closeImageZoom(){this.imageZoom.currentZoomedImage&&(this.imageZoom.currentZoomedImage.classList.remove(this.imageZoom.zoomedClass),this.dispatchEvent("imageZoomClose",{image:this.imageZoom.currentZoomedImage}),this.imageZoom.currentZoomedImage=null,document.body.style.overflow="")}navigateZoomedImage(e){if(!this.imageZoom.currentZoomedImage)return;this.refreshZoomableImages();const t=this.imageZoom.images.indexOf(this.imageZoom.currentZoomedImage);if(-1===t)return;const o=(t+e+this.imageZoom.images.length)%this.imageZoom.images.length,n=this.imageZoom.images[o];n&&this.openImageZoom(n)}}"undefined"==typeof window||window.StandardLoaded||(window.StandardLoaded=!0,window.Standard=Standard,window.standard=new Standard({autoProcess:!0,observeDOM:!0,enableWidowPrevention:!0,enableSmartQuotes:!0,enablePunctuation:!0,enableSpacing:!0,enableFractions:!0,enableArrowsAndSymbols:!0,enableNumberFormatting:!1}),window.standard.initImageZoom(),document.addEventListener("standard:afterProcessAll",e=>{}),document.addEventListener("standard:imageZoomOpen",e=>{}),document.addEventListener("standard:imageZoomClose",e=>{})),"undefined"!=typeof module&&module.exports&&(module.exports={Standard:Standard}),"undefined"!=typeof exports&&(exports.Standard=Standard);